<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Henri Funk" />
  <title>An Introduction to the No U Turn Sampler and dual averaging</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="Presentation_files/reveal.js-3.3.0.1/css/reveal.css"/>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  { color: #cccccc; background-color: #303030; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffcfaf; } /* Alert */
code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #dca3a3; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #f0dfaf; } /* ControlFlow */
code span.ch { color: #dca3a3; } /* Char */
code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
code span.co { color: #7f9f7f; } /* Comment */
code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
code span.do { color: #7f9f7f; } /* Documentation */
code span.dt { color: #dfdfbf; } /* DataType */
code span.dv { color: #dcdccc; } /* DecVal */
code span.er { color: #c3bf9f; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #c0bed1; } /* Float */
code span.fu { color: #efef8f; } /* Function */
code span.im { } /* Import */
code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
code span.kw { color: #f0dfaf; } /* Keyword */
code span.op { color: #f0efd0; } /* Operator */
code span.ot { color: #efef8f; } /* Other */
code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
code span.sc { color: #dca3a3; } /* SpecialChar */
code span.ss { color: #cc9393; } /* SpecialString */
code span.st { color: #cc9393; } /* String */
code span.va { } /* Variable */
code span.vs { color: #cc9393; } /* VerbatimString */
code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */
</style>

<link rel="stylesheet" href="Presentation_files/reveal.js-3.3.0.1/css/theme/simple.css" id="theme">


  <!-- some tweaks to reveal css -->
  <style type="text/css">
    .reveal h1 { font-size: 2.0em; }
    .reveal h2 { font-size: 1.5em;  }
    .reveal h3 { font-size: 1.25em;	}
    .reveal h4 { font-size: 1em;	}

    .reveal .slides>section,
    .reveal .slides>section>section {
      padding: 0px 0px;
    }



    .reveal table {
      border-width: 1px;
      border-spacing: 2px;
      border-style: dotted;
      border-color: gray;
      border-collapse: collapse;
      font-size: 0.7em;
    }

    .reveal table th {
      border-width: 1px;
      padding-left: 10px;
      padding-right: 25px;
      font-weight: bold;
      border-style: dotted;
      border-color: gray;
    }

    .reveal table td {
      border-width: 1px;
      padding-left: 10px;
      padding-right: 25px;
      border-style: dotted;
      border-color: gray;
    }


  </style>

    <style type="text/css">code{white-space: pre;}</style>

    <link rel="stylesheet" href="styles.css"/>

<!-- Printing and PDF exports -->
<script id="paper-css" type="application/dynamic-css">

/* Default Print Stylesheet Template
   by Rob Glazebrook of CSSnewbie.com
   Last Updated: June 4, 2008

   Feel free (nay, compelled) to edit, append, and
   manipulate this file as you see fit. */


@media print {

	/* SECTION 1: Set default width, margin, float, and
	   background. This prevents elements from extending
	   beyond the edge of the printed page, and prevents
	   unnecessary background images from printing */
	html {
		background: #fff;
		width: auto;
		height: auto;
		overflow: visible;
	}
	body {
		background: #fff;
		font-size: 20pt;
		width: auto;
		height: auto;
		border: 0;
		margin: 0 5%;
		padding: 0;
		overflow: visible;
		float: none !important;
	}

	/* SECTION 2: Remove any elements not needed in print.
	   This would include navigation, ads, sidebars, etc. */
	.nestedarrow,
	.controls,
	.fork-reveal,
	.share-reveal,
	.state-background,
	.reveal .progress,
	.reveal .backgrounds {
		display: none !important;
	}

	/* SECTION 3: Set body font face, size, and color.
	   Consider using a serif font for readability. */
	body, p, td, li, div {
		font-size: 20pt!important;
		font-family: Georgia, "Times New Roman", Times, serif !important;
		color: #000;
	}

	/* SECTION 4: Set heading font face, sizes, and color.
	   Differentiate your headings from your body text.
	   Perhaps use a large sans-serif for distinction. */
	h1,h2,h3,h4,h5,h6 {
		color: #000!important;
		height: auto;
		line-height: normal;
		font-family: Georgia, "Times New Roman", Times, serif !important;
		text-shadow: 0 0 0 #000 !important;
		text-align: left;
		letter-spacing: normal;
	}
	/* Need to reduce the size of the fonts for printing */
	h1 { font-size: 28pt !important;  }
	h2 { font-size: 24pt !important; }
	h3 { font-size: 22pt !important; }
	h4 { font-size: 22pt !important; font-variant: small-caps; }
	h5 { font-size: 21pt !important; }
	h6 { font-size: 20pt !important; font-style: italic; }

	/* SECTION 5: Make hyperlinks more usable.
	   Ensure links are underlined, and consider appending
	   the URL to the end of the link for usability. */
	a:link,
	a:visited {
		color: #000 !important;
		font-weight: bold;
		text-decoration: underline;
	}
	/*
	.reveal a:link:after,
	.reveal a:visited:after {
		content: " (" attr(href) ") ";
		color: #222 !important;
		font-size: 90%;
	}
	*/


	/* SECTION 6: more reveal.js specific additions by @skypanther */
	ul, ol, div, p {
		visibility: visible;
		position: static;
		width: auto;
		height: auto;
		display: block;
		overflow: visible;
		margin: 0;
		text-align: left !important;
	}
	.reveal pre,
	.reveal table {
		margin-left: 0;
		margin-right: 0;
	}
	.reveal pre code {
		padding: 20px;
		border: 1px solid #ddd;
	}
	.reveal blockquote {
		margin: 20px 0;
	}
	.reveal .slides {
		position: static !important;
		width: auto !important;
		height: auto !important;

		left: 0 !important;
		top: 0 !important;
		margin-left: 0 !important;
		margin-top: 0 !important;
		padding: 0 !important;
		zoom: 1 !important;

		overflow: visible !important;
		display: block !important;

		text-align: left !important;
		-webkit-perspective: none;
		   -moz-perspective: none;
		    -ms-perspective: none;
		        perspective: none;

		-webkit-perspective-origin: 50% 50%;
		   -moz-perspective-origin: 50% 50%;
		    -ms-perspective-origin: 50% 50%;
		        perspective-origin: 50% 50%;
	}
	.reveal .slides section {
		visibility: visible !important;
		position: static !important;
		width: auto !important;
		height: auto !important;
		display: block !important;
		overflow: visible !important;

		left: 0 !important;
		top: 0 !important;
		margin-left: 0 !important;
		margin-top: 0 !important;
		padding: 60px 20px !important;
		z-index: auto !important;

		opacity: 1 !important;

		page-break-after: always !important;

		-webkit-transform-style: flat !important;
		   -moz-transform-style: flat !important;
		    -ms-transform-style: flat !important;
		        transform-style: flat !important;

		-webkit-transform: none !important;
		   -moz-transform: none !important;
		    -ms-transform: none !important;
		        transform: none !important;

		-webkit-transition: none !important;
		   -moz-transition: none !important;
		    -ms-transition: none !important;
		        transition: none !important;
	}
	.reveal .slides section.stack {
		padding: 0 !important;
	}
	.reveal section:last-of-type {
		page-break-after: avoid !important;
	}
	.reveal section .fragment {
		opacity: 1 !important;
		visibility: visible !important;

		-webkit-transform: none !important;
		   -moz-transform: none !important;
		    -ms-transform: none !important;
		        transform: none !important;
	}
	.reveal section img {
		display: block;
		margin: 15px 0px;
		background: rgba(255,255,255,1);
		border: 1px solid #666;
		box-shadow: none;
	}

	.reveal section small {
		font-size: 0.8em;
	}

}  
</script>


<script id="pdf-css" type="application/dynamic-css">
    
/**
 * This stylesheet is used to print reveal.js
 * presentations to PDF.
 *
 * https://github.com/hakimel/reveal.js#pdf-export
 */

* {
	-webkit-print-color-adjust: exact;
}

body {
	margin: 0 auto !important;
	border: 0;
	padding: 0;
	float: none !important;
	overflow: visible;
}

html {
	width: 100%;
	height: 100%;
	overflow: visible;
}

/* Remove any elements not needed in print. */
.nestedarrow,
.reveal .controls,
.reveal .progress,
.reveal .playback,
.reveal.overview,
.fork-reveal,
.share-reveal,
.state-background {
	display: none !important;
}

h1, h2, h3, h4, h5, h6 {
	text-shadow: 0 0 0 #000 !important;
}

.reveal pre code {
	overflow: hidden !important;
	font-family: Courier, 'Courier New', monospace !important;
}

ul, ol, div, p {
	visibility: visible;
	position: static;
	width: auto;
	height: auto;
	display: block;
	overflow: visible;
	margin: auto;
}
.reveal {
	width: auto !important;
	height: auto !important;
	overflow: hidden !important;
}
.reveal .slides {
	position: static;
	width: 100%;
	height: auto;

	left: auto;
	top: auto;
	margin: 0 !important;
	padding: 0 !important;

	overflow: visible;
	display: block;

	-webkit-perspective: none;
	   -moz-perspective: none;
	    -ms-perspective: none;
	        perspective: none;

	-webkit-perspective-origin: 50% 50%; /* there isn't a none/auto value but 50-50 is the default */
	   -moz-perspective-origin: 50% 50%;
	    -ms-perspective-origin: 50% 50%;
	        perspective-origin: 50% 50%;
}

.reveal .slides section {
	page-break-after: always !important;

	visibility: visible !important;
	position: relative !important;
	display: block !important;
	position: relative !important;

	margin: 0 !important;
	padding: 0 !important;
	box-sizing: border-box !important;
	min-height: 1px;

	opacity: 1 !important;

	-webkit-transform-style: flat !important;
	   -moz-transform-style: flat !important;
	    -ms-transform-style: flat !important;
	        transform-style: flat !important;

	-webkit-transform: none !important;
	   -moz-transform: none !important;
	    -ms-transform: none !important;
	        transform: none !important;
}

.reveal section.stack {
	margin: 0 !important;
	padding: 0 !important;
	page-break-after: avoid !important;
	height: auto !important;
	min-height: auto !important;
}

.reveal img {
	box-shadow: none;
}

.reveal .roll {
	overflow: visible;
	line-height: 1em;
}

/* Slide backgrounds are placed inside of their slide when exporting to PDF */
.reveal section .slide-background {
	display: block !important;
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	z-index: -1;
}

/* All elements should be above the slide-background */
.reveal section>* {
	position: relative;
	z-index: 1;
}

/* Display slide speaker notes when 'showNotes' is enabled */
.reveal .speaker-notes-pdf {
	display: block;
	width: 100%;
	max-height: none;
	left: auto;
	top: auto;
	z-index: 100;
}

/* Display slide numbers when 'slideNumber' is enabled */
.reveal .slide-number-pdf {
	display: block;
	position: absolute;
	font-size: 14px;
}

</script>


<script>
var style = document.createElement( 'style' );
style.type = 'text/css';
var style_script_id = window.location.search.match( /print-pdf/gi ) ? 'pdf-css' : 'paper-css';
var style_script = document.getElementById(style_script_id).text;
style.innerHTML = style_script;
document.getElementsByTagName('head')[0].appendChild(style);
</script>

    <link href="Presentation_files/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
    <link href="Presentation_files/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
    <script src="Presentation_files/kePrint-0.0.1/kePrint.js"></script>
    <link href="Presentation_files/lightable-0.0.1/lightable.css" rel="stylesheet" />
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section>
    <h1 class="title">An Introduction to the No U Turn Sampler and dual averaging</h1>
    <h2 class="author">Henri Funk</h2>
    <h3 class="date">18 12 2020</h3>
</section>

<section><section id="section" class="title-slide slide level1" data-background="#262626"><h1></h1><h1 style="color: #fff">
Hamiltonian Monte Carlo
</h1>
<style>
p.caption {
  font-size: 0.6em;
  font-style: italic;
  color: grey;
  margin-right: 10%;
  margin-left: 10%;
  text-align: justify;
}
</style>
<center>
<img src="files/MH.png" width="876" />
</center>
<!--
## Random Walk

> * proposal in MH is sampled randomly from porpoals/jumping distrib $J_t(\theta_a|\theta_b)$

> * the accpetance rule/ transition function ratio of densities guarantees convergence

<div class="fragment">
$$
\begin{aligned}
T_t(\theta^t|\theta^{t-1}) = \frac{\frac{p(\theta^*|y)}{J(\theta^*|\theta^{t-1})}}{\frac{p(\theta^{t-1}|y)}{J(\theta^{t-1}|\theta^*)}}
\end{aligned}
$$
</div>

> * *But* if steps are poorly chosen converges speed, and accordingly, computational effort can get high

<div class="fragment">
$J(\cdot)$ is only useful jumping distibution, if:

* For any $\theta$ it is easy to sample from $J(\theta_a|\theta_b)$

* It is easy to compute r (e.g. if proposal is symmetric)

* The jump has a *reasonable* distance

* We don't reject/ accept jumps to often
 (see @gelman13)
</div>


## Random Walk Problem

<center>
<img src="files/HMC_multimodal.gif" width="75%" />
</center>


@feng20

> * Gibbs and MH spend a lot of time zigging and zagging in the target distribution

> * Convergence speed depends on the Jumping distribution

--></section><section id="idea" class="slide level2">
<h2>Idea</h2>
<p><br><br></p>
<ul>
<li class="fragment">Introduce a momentum <span class="math inline">\(r_t\)</span> for each component <span class="math inline">\(\theta_t\)</span></li>
</ul>
<p><br><br></p>
<ul>
<li class="fragment">update <span class="math inline">\(\theta\ \&amp; \ r\)</span> simultaneously</li>
</ul>
<p><br><br></p>
<ul>
<li class="fragment">Let the jumping distribution <span class="math inline">\(J(\cdot)\)</span> be largely determined by <span class="math inline">\(r\)</span></li>
</ul>
<p><br><br><br></p>
<div class="fragment">
<p><span class="math inline">\(\Rightarrow\)</span> the resulting algorithm is somewhat a <em>hybrid</em> Monte Carlo with a mix of the known random walk and deterministic simulation methods derived from hamiltonian dynamics</p>
</div>
</section><section id="code---hmc" class="slide level2">
<h2>Code - HMC</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">#&#39; Hamiltonian (hybrid) Monte Carlo</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#&#39;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">#&#39; @param position_init initial sample</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#&#39; @param stepsize length of Leapfrog stepsize</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#&#39; @param leapfrogsteps interger; amount of leapfrogsteps</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">#&#39; @param iterations of HMC algorithm, should be long enough to draw samples from</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#&#39;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>hamiltonianMC &lt;-<span class="st"> </span><span class="cf">function</span>(position_init, stepsize, leapfrogsteps,</span>
<span id="cb1-9"><a href="#cb1-9"></a>                          iterations, design, target,</span>
<span id="cb1-10"><a href="#cb1-10"></a>                          <span class="dt">is_log =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb1-11"><a href="#cb1-11"></a>  pb &lt;-<span class="st"> </span><span class="kw">txtProgressBar</span>(<span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> iterations, <span class="dt">style =</span> <span class="dv">3</span>)</span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="co">###### Preparation ############################################</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="co"># initial position will be our starting value for the algorithm</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>  <span class="co"># positions will be a list containing all of our sampled positions</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>  position &lt;-<span class="st"> </span>position_init</span>
<span id="cb1-16"><a href="#cb1-16"></a>  positions &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="kw">length</span>(position_init), <span class="dt">nrow =</span> iterations))</span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="co">###### HMC Iteration ###########################################</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>  <span class="co"># For `iteration` steps we do:</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>  <span class="co"># we sample a momentum, combined with the position this will be</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>  <span class="co"># our proposal for Leapfrog Steps</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>  <span class="cf">for</span>(iter <span class="cf">in</span> <span class="kw">seq_len</span>(iterations)) {</span>
<span id="cb1-22"><a href="#cb1-22"></a>    momentum &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(position_init))</span>
<span id="cb1-23"><a href="#cb1-23"></a>    proposal &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;position&quot;</span> =<span class="st"> </span>position, <span class="st">&quot;momentum&quot;</span> =<span class="st"> </span>momentum)</span>
<span id="cb1-24"><a href="#cb1-24"></a>    <span class="co">###### Leapfrog Iteration #####################################</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>    <span class="co"># For `leapfrogsteps` steps we do:</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>    <span class="co"># We calculate the partial gradient of our log-posterior at the</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>    <span class="co"># drawn position &amp; recalculate the next proposal by one more</span></span>
<span id="cb1-28"><a href="#cb1-28"></a>    <span class="co"># leapfrogstep</span></span>
<span id="cb1-29"><a href="#cb1-29"></a>    <span class="cf">for</span>(step <span class="cf">in</span> <span class="kw">seq_len</span>(leapfrogsteps)){</span>
<span id="cb1-30"><a href="#cb1-30"></a>      args &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw">is.null</span>(design) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">is.null</span>(target)) {</span>
<span id="cb1-31"><a href="#cb1-31"></a>        <span class="kw">list</span>(proposal<span class="op">$</span>position)</span>
<span id="cb1-32"><a href="#cb1-32"></a>      } <span class="cf">else</span> <span class="kw">list</span>(proposal<span class="op">$</span>position, design, target)</span>
<span id="cb1-33"><a href="#cb1-33"></a>      gradient_prop &lt;-<span class="st"> </span><span class="kw">do.call</span>(gradient, args)</span>
<span id="cb1-34"><a href="#cb1-34"></a>      proposal &lt;-<span class="st"> </span><span class="kw">leapfrog</span>(proposal<span class="op">$</span>position, proposal<span class="op">$</span>momentum, stepsize, gradient_prop)</span>
<span id="cb1-35"><a href="#cb1-35"></a>    }</span>
<span id="cb1-36"><a href="#cb1-36"></a>  <span class="co"># Like in Metropolis-Hastings, we compare the (unnormalized) posterior</span></span>
<span id="cb1-37"><a href="#cb1-37"></a>  <span class="co"># density at our proposal with the density at our previously drawn</span></span>
<span id="cb1-38"><a href="#cb1-38"></a>  <span class="co"># position in the ratio of those two estimates, which will form the</span></span>
<span id="cb1-39"><a href="#cb1-39"></a>  <span class="co"># acceptance probability of our drawn proposal</span></span>
<span id="cb1-40"><a href="#cb1-40"></a>  <span class="co"># If excepted we add the proposal to our output positions variable</span></span>
<span id="cb1-41"><a href="#cb1-41"></a>    acceptance &lt;-<span class="st"> </span>(<span class="kw">joint_probability</span>(proposal<span class="op">$</span>position, proposal<span class="op">$</span>momentum, <span class="dt">design =</span> design, <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log) <span class="op">/</span></span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="st">                     </span><span class="kw">joint_probability</span>(position, momentum, <span class="dt">design =</span> design, <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log))</span>
<span id="cb1-43"><a href="#cb1-43"></a>    <span class="cf">if</span>(<span class="kw">is.na</span>(acceptance)) acceptance &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb1-44"><a href="#cb1-44"></a>    acceptance &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="dv">1</span>, acceptance)</span>
<span id="cb1-45"><a href="#cb1-45"></a>    positions[iter, ] &lt;-<span class="st"> </span>position &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">&lt;</span><span class="st"> </span>acceptance) proposal<span class="op">$</span>position <span class="cf">else</span> position</span>
<span id="cb1-46"><a href="#cb1-46"></a>    <span class="kw">setTxtProgressBar</span>(pb, iter)</span>
<span id="cb1-47"><a href="#cb1-47"></a>  }</span>
<span id="cb1-48"><a href="#cb1-48"></a>  <span class="kw">return</span>(positions)</span>
<span id="cb1-49"><a href="#cb1-49"></a>}</span></code></pre></div>
</section><section id="section-1" class="slide level2" data-background="files/HMC_problem.gif">
<h2></h2>
<p>Problem <span class="citation" data-cites="feng20">Feng (2016)</span></p>
<ul>
<li class="fragment">taking too few or too large steps <span class="math inline">\(\Rightarrow \ \theta^t\ \&amp; \ \theta^{t+1}\)</span> end up very close.</li>
</ul>
<!---
## (Hand-)Tuning Parameters

* $\epsilon = stepsize$


* $\mathcal{L} = \#Leapfrogsteps$


* $\phi = momentum$


<div class="fragment">
But how?

<center>
<img src="files/Questioning.gif" width="40%" />
</center>
</div>

## Setting the tuning parameters

<div class="fragment">
* *Radius*:
  
  stay in the radius of you target distribution. Rule of thumb: $\epsilon \mathcal{L} = 1$
</div>

<div class="fragment">
* *adaptive updating*: 

  1) run $M_{init}$ steps with initial setting

  2) adjust the parameters based on knowledge from previous run and rerun the model for $M_{adjust}$ steps
</div>

<div class="fragment">
* *Acceptance Sweet Spot*: 65% acceptance rate ($\alpha$)
  
  if $\alpha < 0.65 \Rightarrow$ leapfrog jumps are too ambitious.
  Set $\mathcal{L}\uparrow, \epsilon \downarrow$.
  
  if $\alpha > 0.65 \Rightarrow$ leapfrog jumps are too cautious.
  Set $\mathcal{L}  \downarrow, \epsilon \uparrow$.
(see @gelman13)
</div>
--->
</section><section id="desirable-behavoir-for-tuning-parameters-tuning-parameters-hmc" class="slide level2">
<h2>Desirable behavoir for tuning parameters tuning parameters HMC:</h2>
<p><br></p>
<ol type="1">
<li class="fragment"><span class="math inline">\(\mathcal{L}\)</span> driving the trajectory of steps in one iteration though the whole posterior space.<br />
<em>Tackeled by NUTS</em></li>
</ol>
<p><br></p>
<ol start="2" type="1">
<li class="fragment"><span class="math inline">\(\epsilon\)</span> getting smaller in areas of high curvature exploiting various areas.<br />
<em>Tackeled by dual averaging</em></li>
</ol>
<p><br></p>
<ol start="3" type="1">
<li class="fragment"><span class="math inline">\(Covar(\phi)\)</span> scaling to the local curvature.<br />
<em>Riemanian Integral</em></li>
</ol>
<p><br></p>
<div class="fragment">
<p><span class="math inline">\(\Rightarrow\)</span> All three approaches may be combined. In the following we will discuss the implementation for a No-U-Turn sampler with dual averaging, as discussed in Gelman and Hoffman (2014). <span class="citation" data-cites="hoffman2014">Hoffman and Gelman (2014)</span></p>
</div>
</section></section>
<section><section id="section-2" class="title-slide slide level1" data-background="#262626"><h1></h1><h1 style="color: #fff">
The (naive) No-U-Turn Sampler
</h1>
<center>
<img src="files/HMC.png" width="876" />
</center>
<!--
NOTES:
> * As we use the information from Hamiltonian dynamics to tune $\epsilon$ and $\mathcal{L}$ within the run iteration don't guarantee convergence anymore

> * Property of markov chain is not given anymore

<div class="fragment">
* What do we do now?

  + Derive a heuristic when we want to stop the sampling
  + Ensure the adaption satisfies the Markov Chain properties
</div>
--></section><section id="heuristic-stopping-criteria" class="slide level2">
<h2>Heuristic Stopping Criteria</h2>
</small>
<div class="fragment">
<ul>
<li>Lets look at one iteration <span class="math inline">\(t\)</span> in HMC where we intentionally set
<ol type="a">
<li><span class="math inline">\(\mathcal{L_t}\)</span> to small</li>
<li><span class="math inline">\(\mathcal{L_t}\)</span> to high</li>
</ol></li>
</ul>
</div>
<br>
<div class="fragment">
<ul>
<li>The <span class="math inline">\(\mathcal{L_t}\)</span>-Leapfrog steps performed from starting state <span class="math inline">\((\theta_{right}, r_{right})\)</span> in phase-space to their end <span class="math inline">\((\theta_{left}, r_{left})\)</span> after <span class="math inline">\(\mathcal{L_t}\)</span> Leapfrogsteps might look as follows: <br></li>
</ul>
</div>
<div class="fragment">
<center>
<div class="figure">
<img src="files/U-Turn-Criteria.png" alt="Left Plot: Expanding the trajectory in either direction typically extends the trajectory further  across the energy level set (grey) towards unexplored neighborhood. Right Plot: Further expansion typically contracts the boundaries of the trajectory towards each other and neighborhoods that have already been explored." width="50%" />
<p class="caption">
Left Plot: Expanding the trajectory in either direction typically extends the trajectory further across the energy level set (grey) towards unexplored neighborhood. Right Plot: Further expansion typically contracts the boundaries of the trajectory towards each other and neighborhoods that have already been explored.
</p>
</div>
Criterion <span class="math display">\[
r_{right} (\theta_{left} - \theta_{right}) &lt; 0
\]</span>
</center>
</div>
<p></small></p>
</section><section id="naive-stepwise-exploration-scheme" class="slide level2">
<h2>Naive Stepwise Exploration Scheme</h2>
<p><br></p>
<ol type="1">
<li class="fragment">Build a trajectory with a given length</li>
</ol>
<p><br></p>
<ol start="2" type="1">
<li class="fragment">Check the Termination (No-U-Turn) Criterion</li>
</ol>
<p><br></p>
<ol start="3" type="1">
<li class="fragment">Expand the trajectory and &amp; Repeat Checks</li>
</ol>
<p><br></p>
<ol start="4" type="1">
<li class="fragment">Return the sample once the criterion is met</li>
</ol>
<p><br></p>
<div class="fragment">
<p><strong>Naive Additive Scheme</strong>: Check the termination Criteria for each and every point between any two points Smart <br> <strong>Multiplicative Scheme</strong>: Double the trajectory to the old trajectory and so create a balanced binary tree. Compare the criterion only between subtrees.</p>
</div>
</section><section id="doubling--expand-the-trajectory" class="slide level2">
<h2>Doubling- expand the trajectory</h2>
<center>
<div class="figure">
<img src="files/Doubling.png" alt="Typical doubling proccedure. The initial point is black. Each colour desricbes a new subtree." width="75%" />
<p class="caption">
Typical doubling proccedure. The initial point is black. Each colour desricbes a new subtree.
</p>
</div>
<span class="citation" data-cites="hoffman2014">Hoffman and Gelman (2014)</span>
</center>
<div class="fragment">
<p>The doubling is halted when the sub-trajectories from the leftmost to the rightmost nodes of any balanced binary tree start to double back on themselves.</p>
<p><em>Info:</em> We have to double fore- and backwards in our trajectory to guarantee reversibility in time</p>
</div>
</section><section id="slice-to-the-rescue---valid-states" class="slide level2">
<h2>Slice to the Rescue - Valid States</h2>
<div class="fragment">
Some of the trajectory points sampled have to be condemn because they exhibit pathological behavior.
<center>
<img src="files/Leapfrog_Discretization.png" width="50%" />
</center>
<div class="fragment">
<p>To determine those points we introduce a slice variable <span class="math inline">\(u\)</span> to our posterior</p>
</div>
<div class="fragment">
<p>We sample from <span class="math inline">\(u \sim Unif(u; [0, e^{\mathcal{L}(\theta_t) - \frac{1}{2} &lt;r_t,r_t&gt;}])\)</span> and for each state <span class="math inline">\((\hat{\theta}, \hat{r})\)</span> we propose during the next iteration <span class="math inline">\(t+1\)</span> the unnormalized joint posterior at this point has to be higher than u to be <strong>valid</strong>.</p>
</div>
<div class="fragment">
<p><span class="math inline">\((\hat{\theta}, \hat{r})\)</span> is only a valid state if:</p>
<p><span class="math display">\[
u \leq exp(\mathcal{L}(\hat{\theta}) - \frac{1}{2} &lt;\hat{r},\hat{r}&gt;)
\]</span></p>
</div>
<div class="fragment">
<p>This is comparable to the acceptance / rejection step in HMC</p>
</div>
<div class="fragment">
<p><em>Alternative:</em> draw from multinomial over states in the trajectory</p>
</div>
</section><section id="mathcalb-mathcalc-in-nuts" class="slide level2">
<h2><span class="math inline">\(\mathcal{B}, \mathcal{C}\)</span> in NUTS</h2>
<p><span class="math inline">\(\mathcal{B}\)</span>: constituted by all leaves of the binary tree generated in the doubling proccedure of one NUTS iteration. If <span class="math inline">\(j\)</span> denotes the depth of a tree the amount of visited states through doubling in leapfrog trajectory is <span class="math inline">\(\#\mathcal{B} = 2^j-1\)</span>.<br />
<span class="math inline">\(\mathcal{C}\)</span>: contains all valid states visited.</p>
<div class="fragment">
<center>
<div class="figure">
<img src="files/trajectory.png" alt="Example of a trajectory generated during one iteration of NUTS." width="50%" />
<p class="caption">
Example of a trajectory generated during one iteration of NUTS.
</p>
</div>
</center>
</div>
</section><section id="error-correction-stopping-criteria" class="slide level2">
<h2>Error correction Stopping Criteria</h2>
<p>Lets sample a slice using information from the position and momentum sampled in the previous iteration.</p>
<p>The slice helps us to build another stopping criteria. It berries information of the likelihood from our previous iteration, as it is sampled from <span class="math inline">\(u \sim Unif(u; [0, e^{\mathcal{L}(\theta_t) - \frac{1}{2} &lt;r_t,r_t&gt;}])\)</span>. So we can use it to identify errors from our hamiltonian trajectory:</p>
<p>Given a new proposal state <span class="math inline">\((\hat{\theta}, \hat{r})\)</span> sampled via leapfrogsteps, we stop our doubling, if</p>
<p><span class="math display">\[
\begin{aligned}
\mathcal{L}(\hat{\theta}, \hat{r}) - log(u)&amp; &lt; -\Delta_{max} \\
 = log(\frac{p(\hat{\theta}, \hat{r})}{u})&amp; &lt; -\Delta_{max}
\end{aligned}
\]</span> Set <span class="math inline">\(\Delta_{max}\)</span> to a very high value like 1000. So basically if <span class="math inline">\(p(\hat{\theta}, \hat{r})\)</span> is the proportional likelihood is way less likely compared to our slice we stop simulating.</p>
</section><section id="implement-nuts---initialize" class="slide level2">
<h2>Implement NUTS - Initialize</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">#&#39; Simplified naive U-Turn-Sampler Showcase</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">#&#39;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">#&#39; @param position_init initial value for theta</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">#&#39; @param stepsize size \epsilon for leapfrog steps</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">#&#39; @param iteration number of iterations to sample from</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">#&#39; @param design a design matrix, if posterior is a model</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">#&#39; @param target a target feature vector if posterior is a model</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">#&#39; @param is_log if the likelihood is already logged</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">#&#39;</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>sample_naiveNUTS_s &lt;-<span class="st"> </span><span class="cf">function</span>(position_init, stepsize, iteration, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>, <span class="dt">is_log =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="co">###### Preparation ############################################</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="co"># initial position will be our starting value for the algorithm</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  <span class="co"># positions will be a list containing all of our sampled positions</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>  position &lt;-<span class="st"> </span>position_init</span>
<span id="cb2-15"><a href="#cb2-15"></a>  positions &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="kw">length</span>(position_init), <span class="dt">nrow =</span> iteration))</span>
<span id="cb2-16"><a href="#cb2-16"></a>}</span></code></pre></div>
</section><section id="implement-nuts---itertation" class="slide level2">
<h2>Implement NUTS - Itertation</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">#&#39; Simplified naive U-Turn-Sampler Showcase</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">#&#39;</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">#&#39; @param position_init initial value for theta</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">#&#39; @param stepsize size \epsilon for leapfrog steps</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">#&#39; @param iteration number of iterations to sample from</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">#&#39; @param design a design matrix, if posterior is a model</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#&#39; @param target a target feature vector if posterior is a model</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">#&#39; @param is_log if the likelihood is already logged</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">#&#39;</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>sample_naiveNUTS_s &lt;-<span class="st"> </span><span class="cf">function</span>(position_init, stepsize, iteration, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>, <span class="dt">is_log =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="co">###### Preparation ############################################</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>  <span class="co"># initial position will be our starting value for the algorithm</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>  <span class="co"># positions will be a list containing all of our sampled positions</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>  position &lt;-<span class="st"> </span>position_init</span>
<span id="cb3-15"><a href="#cb3-15"></a>  positions &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="kw">length</span>(position_init), <span class="dt">nrow =</span> iteration))</span>
<span id="cb3-16"><a href="#cb3-16"></a>  <span class="co">###### NUTS Iteration ##########################################</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>  <span class="co"># For `iteration` steps we do:</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>  <span class="co"># we sample a momentum, combined with the position this will be</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>  <span class="co"># our proposal for Leapfrog Steps,</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>  <span class="co"># we initialize `tree_depth` as identifier for the depth and doubling</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>  <span class="co"># we form a slice &amp; sample uniformly from 0 to the joint probability at current</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>  <span class="co"># position and momentum</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>  <span class="co"># we also set up a state that contains information about valid_states</span></span>
<span id="cb3-24"><a href="#cb3-24"></a>  <span class="co"># sampled from Leapfrogsteps, our leftmost and rightmost state of</span></span>
<span id="cb3-25"><a href="#cb3-25"></a>  <span class="co"># our trajectory and &#39;run&#39; a criterion that tells us if we made the U-turn</span></span>
<span id="cb3-26"><a href="#cb3-26"></a>  <span class="co"># during our last doubling</span></span>
<span id="cb3-27"><a href="#cb3-27"></a>  <span class="cf">for</span>(m <span class="cf">in</span> 1L<span class="op">:</span>(iteration)) {</span>
<span id="cb3-28"><a href="#cb3-28"></a>    momentum &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(position))</span>
<span id="cb3-29"><a href="#cb3-29"></a>    slice &lt;-<span class="st"> </span><span class="kw">runif</span>(1L, <span class="dt">max =</span> <span class="kw">exp</span>(<span class="kw">joint_probability</span>(position, momentum, design, target)))</span>
<span id="cb3-30"><a href="#cb3-30"></a>    state &lt;-<span class="st"> </span><span class="kw">initialize_state</span>(position, momentum)</span>
<span id="cb3-31"><a href="#cb3-31"></a>    tree_depth &lt;-<span class="st"> </span>0L</span>
<span id="cb3-32"><a href="#cb3-32"></a>  }</span>
<span id="cb3-33"><a href="#cb3-33"></a>}</span></code></pre></div>
</section><section id="implement-nuts---doubling-the-tree" class="slide level2">
<h2>Implement NUTS - Doubling the tree</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">#&#39; Simplified naive U-Turn-Sampler Showcase</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">#&#39;</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">#&#39; @param position_init initial value for theta</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">#&#39; @param stepsize size \epsilon for leapfrog steps</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">#&#39; @param iteration number of iterations to sample from</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#&#39; @param design a design matrix, if posterior is a model</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#&#39; @param target a target feature vector if posterior is a model</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">#&#39; @param is_log if the likelihood is already logged</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">#&#39;</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>sample_naiveNUTS_s &lt;-<span class="st"> </span><span class="cf">function</span>(position_init, stepsize, iteration, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>, <span class="dt">is_log =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb4-11"><a href="#cb4-11"></a>  <span class="co">###### Preparation ############################################</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>  <span class="co"># initial position will be our starting value for the algorithm</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>  <span class="co"># positions will be a list containing all of our sampled positions</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>  position &lt;-<span class="st"> </span>position_init</span>
<span id="cb4-15"><a href="#cb4-15"></a>  positions &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="kw">length</span>(position_init), <span class="dt">nrow =</span> iteration))</span>
<span id="cb4-16"><a href="#cb4-16"></a>  <span class="co">###### NUTS Iteration ##########################################</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>  <span class="co"># For `iteration` steps we do:</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>  <span class="co"># we sample a momentum, combined with the position this will be</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>  <span class="co"># our proposal for Leapfrog Steps,</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>  <span class="co"># we initialize `tree_depth` as identifier for the depth and doubling</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>  <span class="co"># we form a slice &amp; sample uniformly from 0 to the joint probability at current</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>  <span class="co"># position and momentum</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>  <span class="co"># we also set up a state that contains information about valid_states</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>  <span class="co"># sampled from Leapfrogsteps, our leftmost and rightmost state of</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>  <span class="co"># our trajectory and &#39;run&#39; a criterion that tells us if we made the U-turn</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>  <span class="co"># during our last doubling</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>  <span class="cf">for</span>(m <span class="cf">in</span> 1L<span class="op">:</span>(iteration)) {</span>
<span id="cb4-28"><a href="#cb4-28"></a>    momentum &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(position))</span>
<span id="cb4-29"><a href="#cb4-29"></a>    slice &lt;-<span class="st"> </span><span class="kw">runif</span>(1L, <span class="dt">max =</span> <span class="kw">exp</span>(<span class="kw">joint_probability</span>(position, momentum, design, target)))</span>
<span id="cb4-30"><a href="#cb4-30"></a>    state &lt;-<span class="st"> </span><span class="kw">initialize_state</span>(position, momentum)</span>
<span id="cb4-31"><a href="#cb4-31"></a>    tree_depth &lt;-<span class="st"> </span>0L</span>
<span id="cb4-32"><a href="#cb4-32"></a>    <span class="co">###### Build Tree ##########################################</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>    <span class="co"># While our Leapfrogsteps didn&#39;t made a U-Turn we do:</span></span>
<span id="cb4-34"><a href="#cb4-34"></a>    <span class="co"># 1) sample a direction to integrate Leapfrogsteps</span></span>
<span id="cb4-35"><a href="#cb4-35"></a>    <span class="co">#   a) foreward in time (+1)</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>    <span class="co">#   b) backward in time (-1)</span></span>
<span id="cb4-37"><a href="#cb4-37"></a>    <span class="co"># 2) build a tree in the previously chosen direction</span></span>
<span id="cb4-38"><a href="#cb4-38"></a>    <span class="co"># 3) update our right-/leftmost lepfrog node</span></span>
<span id="cb4-39"><a href="#cb4-39"></a>    <span class="co"># 4) Check if U-Turn was made between</span></span>
<span id="cb4-40"><a href="#cb4-40"></a>    <span class="co">#   a) sub trees performed in build tree</span></span>
<span id="cb4-41"><a href="#cb4-41"></a>    <span class="co">#   b) the whole tree</span></span>
<span id="cb4-42"><a href="#cb4-42"></a>    <span class="cf">while</span>(state<span class="op">$</span>run) {</span>
<span id="cb4-43"><a href="#cb4-43"></a>      <span class="co"># 1 means forward, -1 means backward doubling</span></span>
<span id="cb4-44"><a href="#cb4-44"></a>      direction &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span>1L, 1L), 1L)</span>
<span id="cb4-45"><a href="#cb4-45"></a>      state_proposal &lt;-<span class="st"> </span><span class="cf">if</span>(direction <span class="op">==</span><span class="st"> </span><span class="dv">-1</span>) {</span>
<span id="cb4-46"><a href="#cb4-46"></a>        <span class="kw">build_tree</span>(state<span class="op">$</span>leftmost, slice, direction, tree_depth, <span class="dt">stepsize =</span> stepsize,</span>
<span id="cb4-47"><a href="#cb4-47"></a>                   <span class="dt">design =</span> design, <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log)</span>
<span id="cb4-48"><a href="#cb4-48"></a>      } <span class="cf">else</span>{</span>
<span id="cb4-49"><a href="#cb4-49"></a>        <span class="kw">build_tree</span>(state<span class="op">$</span>rightmost, slice, direction, tree_depth, <span class="dt">stepsize =</span> stepsize,</span>
<span id="cb4-50"><a href="#cb4-50"></a>                   <span class="dt">design =</span> design, <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log)</span>
<span id="cb4-51"><a href="#cb4-51"></a>      }</span>
<span id="cb4-52"><a href="#cb4-52"></a>      <span class="cf">if</span>(state_proposal<span class="op">$</span>run) {</span>
<span id="cb4-53"><a href="#cb4-53"></a>        <span class="cf">if</span>(direction <span class="op">==</span><span class="st"> </span><span class="dv">-1</span>) {</span>
<span id="cb4-54"><a href="#cb4-54"></a>          state<span class="op">$</span>leftmost &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>leftmost</span>
<span id="cb4-55"><a href="#cb4-55"></a>          state<span class="op">$</span>valid_state &lt;-<span class="st"> </span><span class="kw">unite_valid_states</span>(state_proposal, state)</span>
<span id="cb4-56"><a href="#cb4-56"></a>        } <span class="cf">else</span>{</span>
<span id="cb4-57"><a href="#cb4-57"></a>          state<span class="op">$</span>rightmost &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>rightmost</span>
<span id="cb4-58"><a href="#cb4-58"></a>          state<span class="op">$</span>valid_state &lt;-<span class="st"> </span><span class="kw">unite_valid_states</span>(state, state_proposal)</span>
<span id="cb4-59"><a href="#cb4-59"></a>        }</span>
<span id="cb4-60"><a href="#cb4-60"></a>      }</span>
<span id="cb4-61"><a href="#cb4-61"></a>      state<span class="op">$</span>run &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>run <span class="op">*</span><span class="st"> </span><span class="kw">is_U_turn</span>(<span class="dt">state =</span> state)</span>
<span id="cb4-62"><a href="#cb4-62"></a>      tree_depth &lt;-<span class="st"> </span>tree_depth <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb4-63"><a href="#cb4-63"></a>    }</span>
<span id="cb4-64"><a href="#cb4-64"></a>  }</span>
<span id="cb4-65"><a href="#cb4-65"></a>}</span></code></pre></div>
</section><section id="implement-nuts---sample-a-state" class="slide level2">
<h2>Implement NUTS - Sample a state</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">#&#39; Simplified naive U-Turn-Sampler Showcase</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">#&#39;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">#&#39; @param position_init initial value for theta</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">#&#39; @param stepsize size \epsilon for leapfrog steps</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">#&#39; @param iteration number of iterations to sample from</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co">#&#39; @param design a design matrix, if posterior is a model</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">#&#39; @param target a target feature vector if posterior is a model</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">#&#39; @param is_log if the likelihood is already logged</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">#&#39;</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>sample_naiveNUTS_s &lt;-<span class="st"> </span><span class="cf">function</span>(position_init, stepsize, iteration, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>, <span class="dt">is_log =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="co">###### Preparation ############################################</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>  <span class="co"># initial position will be our starting value for the algorithm</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="co"># positions will be a list containing all of our sampled positions</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>  position &lt;-<span class="st"> </span>position_init</span>
<span id="cb5-15"><a href="#cb5-15"></a>  positions &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="kw">length</span>(position_init), <span class="dt">nrow =</span> iteration))</span>
<span id="cb5-16"><a href="#cb5-16"></a>  <span class="co">###### NUTS Iteration ##########################################</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>  <span class="co"># For `iteration` steps we do:</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>  <span class="co"># we sample a momentum, combined with the position this will be</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>  <span class="co"># our proposal for Leapfrog Steps,</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>  <span class="co"># we initialize `tree_depth` as identifier for the depth and doubling</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="co"># we form a slice &amp; sample uniformly from 0 to the joint probability at current</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>  <span class="co"># position and momentum</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>  <span class="co"># we also set up a state that contains information about valid_states</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>  <span class="co"># sampled from Leapfrogsteps, our leftmost and rightmost state of</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>  <span class="co"># our trajectory and &#39;run&#39; a criterion that tells us if we made the U-turn</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>  <span class="co"># during our last doubling</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>  <span class="cf">for</span>(m <span class="cf">in</span> 1L<span class="op">:</span>(iteration)) {</span>
<span id="cb5-28"><a href="#cb5-28"></a>    momentum &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(position))</span>
<span id="cb5-29"><a href="#cb5-29"></a>    slice &lt;-<span class="st"> </span><span class="kw">runif</span>(1L, <span class="dt">max =</span> <span class="kw">exp</span>(<span class="kw">joint_probability</span>(position, momentum, design, target)))</span>
<span id="cb5-30"><a href="#cb5-30"></a>    state &lt;-<span class="st"> </span><span class="kw">initialize_state</span>(position, momentum)</span>
<span id="cb5-31"><a href="#cb5-31"></a>    tree_depth &lt;-<span class="st"> </span>0L</span>
<span id="cb5-32"><a href="#cb5-32"></a>    <span class="co">###### Build Tree ##########################################</span></span>
<span id="cb5-33"><a href="#cb5-33"></a>    <span class="co"># While our Leapfrogsteps didn&#39;t made a U-Turn we do:</span></span>
<span id="cb5-34"><a href="#cb5-34"></a>    <span class="co"># 1) sample a direction to integrate Leapfrogsteps</span></span>
<span id="cb5-35"><a href="#cb5-35"></a>    <span class="co">#   a) foreward in time (+1)</span></span>
<span id="cb5-36"><a href="#cb5-36"></a>    <span class="co">#   b) backward in time (-1)</span></span>
<span id="cb5-37"><a href="#cb5-37"></a>    <span class="co"># 2) build a tree in the previously chosen direction</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>    <span class="co"># 3) update our right-/leftmost lepfrog node</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>    <span class="co"># 4) Check if U-Turn was made between</span></span>
<span id="cb5-40"><a href="#cb5-40"></a>    <span class="co">#   a) sub trees performed in build tree</span></span>
<span id="cb5-41"><a href="#cb5-41"></a>    <span class="co">#   b) the whole tree</span></span>
<span id="cb5-42"><a href="#cb5-42"></a>    <span class="cf">while</span>(state<span class="op">$</span>run) {</span>
<span id="cb5-43"><a href="#cb5-43"></a>      <span class="co"># 1 means forward, -1 means backward doubling</span></span>
<span id="cb5-44"><a href="#cb5-44"></a>      direction &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span>1L, 1L), 1L)</span>
<span id="cb5-45"><a href="#cb5-45"></a>      state_proposal &lt;-<span class="st"> </span><span class="cf">if</span>(direction <span class="op">==</span><span class="st"> </span><span class="dv">-1</span>) {</span>
<span id="cb5-46"><a href="#cb5-46"></a>        <span class="kw">build_tree</span>(state<span class="op">$</span>leftmost, slice, direction, tree_depth, <span class="dt">stepsize =</span> stepsize,</span>
<span id="cb5-47"><a href="#cb5-47"></a>                   <span class="dt">design =</span> design, <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log)</span>
<span id="cb5-48"><a href="#cb5-48"></a>      } <span class="cf">else</span>{</span>
<span id="cb5-49"><a href="#cb5-49"></a>        <span class="kw">build_tree</span>(state<span class="op">$</span>rightmost, slice, direction, tree_depth, <span class="dt">stepsize =</span> stepsize,</span>
<span id="cb5-50"><a href="#cb5-50"></a>                   <span class="dt">design =</span> design, <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log)</span>
<span id="cb5-51"><a href="#cb5-51"></a>      }</span>
<span id="cb5-52"><a href="#cb5-52"></a>      <span class="cf">if</span>(state_proposal<span class="op">$</span>run) {</span>
<span id="cb5-53"><a href="#cb5-53"></a>        <span class="cf">if</span>(direction <span class="op">==</span><span class="st"> </span><span class="dv">-1</span>) {</span>
<span id="cb5-54"><a href="#cb5-54"></a>          state<span class="op">$</span>leftmost &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>leftmost</span>
<span id="cb5-55"><a href="#cb5-55"></a>          state<span class="op">$</span>valid_state &lt;-<span class="st"> </span><span class="kw">unite_valid_states</span>(state_proposal, state)</span>
<span id="cb5-56"><a href="#cb5-56"></a>        } <span class="cf">else</span>{</span>
<span id="cb5-57"><a href="#cb5-57"></a>          state<span class="op">$</span>rightmost &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>rightmost</span>
<span id="cb5-58"><a href="#cb5-58"></a>          state<span class="op">$</span>valid_state &lt;-<span class="st"> </span><span class="kw">unite_valid_states</span>(state, state_proposal)</span>
<span id="cb5-59"><a href="#cb5-59"></a>        }</span>
<span id="cb5-60"><a href="#cb5-60"></a>      }</span>
<span id="cb5-61"><a href="#cb5-61"></a>      state<span class="op">$</span>run &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>run <span class="op">*</span><span class="st"> </span><span class="kw">is_U_turn</span>(<span class="dt">state =</span> state)</span>
<span id="cb5-62"><a href="#cb5-62"></a>      tree_depth &lt;-<span class="st"> </span>tree_depth <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb5-63"><a href="#cb5-63"></a>    }</span>
<span id="cb5-64"><a href="#cb5-64"></a>  <span class="co"># Use the Transition kernel:</span></span>
<span id="cb5-65"><a href="#cb5-65"></a>  <span class="co"># Sample uniformly one of the valid states drawn through Leapfrog steps</span></span>
<span id="cb5-66"><a href="#cb5-66"></a>    <span class="cf">if</span>(<span class="kw">is.matrix</span>(state<span class="op">$</span>valid_state<span class="op">$</span>position) <span class="op">||</span></span>
<span id="cb5-67"><a href="#cb5-67"></a><span class="st">       </span><span class="kw">is.data.frame</span>(state<span class="op">$</span>valid_state<span class="op">$</span>position)) {</span>
<span id="cb5-68"><a href="#cb5-68"></a>      row_id &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">seq_len</span>(<span class="kw">nrow</span>(state<span class="op">$</span>valid_state<span class="op">$</span>position)), 1L)</span>
<span id="cb5-69"><a href="#cb5-69"></a>      positions[m, ] &lt;-<span class="st"> </span>state<span class="op">$</span>valid_state<span class="op">$</span>position[row_id, ]</span>
<span id="cb5-70"><a href="#cb5-70"></a>      position =<span class="st"> </span><span class="kw">as.numeric</span>(positions[m, ])</span>
<span id="cb5-71"><a href="#cb5-71"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-72"><a href="#cb5-72"></a>      positions[m, ] &lt;-<span class="st"> </span>position</span>
<span id="cb5-73"><a href="#cb5-73"></a>    }</span>
<span id="cb5-74"><a href="#cb5-74"></a>  }</span>
<span id="cb5-75"><a href="#cb5-75"></a>  positions</span>
<span id="cb5-76"><a href="#cb5-76"></a>}</span></code></pre></div>
</section><section id="implement-build-trees---initialize" class="slide level2">
<h2>Implement Build Trees - Initialize</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">#&#39; Build Trees doubles the positions and momentum and such the trajectory length</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">#&#39;</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#&#39; Repeatedly called by NUTS until run == FALSE, that is when a U-Turn is performed.</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#&#39;</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&#39; @param position_momentum list, containing actual position and momentum</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#&#39; @param slice drawn slice sample to validate position-/momentum steps</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">#&#39; @param direction determines whether trajectory should explore forwards or backwards</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#&#39; @param tree_depth balanced tree depth with momentum and position states in the tree nodes</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">#&#39; @param is_log logical, indicator if joint probability is already logged</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">#&#39; @param stepsize parsed stepsize \epsilon to Leapfrog step function</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">#&#39; @param design design matrix of features for linear modell</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">#&#39; @param target target variable to validate predictions</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">#&#39; @param deltamax stop if the error in simulation increases</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co">#&#39; @param run independent argument that tells build tree if stopping criteria is met</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">#&#39; @param valid_states all valid states visited so far</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">#&#39;</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>build_tree_simply &lt;-<span class="st"> </span><span class="cf">function</span>(position_momentum, slice, direction, tree_depth,</span>
<span id="cb6-18"><a href="#cb6-18"></a>                              is_log, stepsize, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>,</span>
<span id="cb6-19"><a href="#cb6-19"></a>                              <span class="dt">deltamax =</span> 1000L, <span class="dt">run =</span> <span class="dv">1</span>,</span>
<span id="cb6-20"><a href="#cb6-20"></a>                              <span class="dt">valid_states =</span> <span class="kw">structure</span>(<span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> 2L))) {</span>
<span id="cb6-21"><a href="#cb6-21"></a>}</span></code></pre></div>
</section><section id="implement-build-trees---base-case" class="slide level2">
<h2>Implement Build Trees - Base Case</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">#&#39; Build Trees doubles the positions and momentum and such the trajectory length</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co">#&#39;</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">#&#39; Repeatedly called by NUTS until run == FALSE, that is when a U-Turn is performed.</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#&#39;</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#&#39; @param position_momentum list, containing actual position and momentum</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">#&#39; @param slice drawn slice sample to validate position-/momentum steps</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">#&#39; @param direction determines whether trajectory should explore forwards or backwards</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">#&#39; @param tree_depth balanced tree depth with momentum and position states in the tree nodes</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">#&#39; @param is_log logical, indicator if joint probability is already logged</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">#&#39; @param stepsize parsed stepsize \epsilon to Leapfrog step function</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co">#&#39; @param design design matrix of features for linear modell</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">#&#39; @param target target variable to validate predictions</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co">#&#39; @param deltamax stop if the error in simulation increases</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">#&#39; @param run independent argument that tells build tree if stopping criteria is met</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co">#&#39; @param valid_states all valid states visited so far</span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="co">#&#39;</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>build_tree_simply &lt;-<span class="st"> </span><span class="cf">function</span>(position_momentum, slice, direction, tree_depth,</span>
<span id="cb7-18"><a href="#cb7-18"></a>                              is_log, stepsize, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>,</span>
<span id="cb7-19"><a href="#cb7-19"></a>                              <span class="dt">deltamax =</span> 1000L, <span class="dt">run =</span> <span class="dv">1</span>,</span>
<span id="cb7-20"><a href="#cb7-20"></a>                              <span class="dt">valid_states =</span> <span class="kw">structure</span>(<span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> 2L))) {</span>
<span id="cb7-21"><a href="#cb7-21"></a>  <span class="co">###### Base Case ###########################################</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>  <span class="co"># if tree_depth is zero: Call build leaf,</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>  <span class="co"># take one leapfrog step into direction</span></span>
<span id="cb7-24"><a href="#cb7-24"></a>  <span class="cf">if</span>(tree_depth <span class="op">==</span><span class="st"> </span>0L) {</span>
<span id="cb7-25"><a href="#cb7-25"></a>    <span class="kw">build_leaf</span>(position_momentum, slice, direction, tree_depth,</span>
<span id="cb7-26"><a href="#cb7-26"></a>               <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb7-27"><a href="#cb7-27"></a>               <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log)</span>
<span id="cb7-28"><a href="#cb7-28"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-29"><a href="#cb7-29"></a>    }</span>
<span id="cb7-30"><a href="#cb7-30"></a>}</span></code></pre></div>
</section><section id="implement-build-leaf" class="slide level2">
<h2>Implement Build Leaf</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>build_leaf_simply &lt;-<span class="st"> </span><span class="cf">function</span>(position_momentum, slice, direction, tree_depth,</span>
<span id="cb8-2"><a href="#cb8-2"></a>                              stepsize, deltamax, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>,</span>
<span id="cb8-3"><a href="#cb8-3"></a>                              is_log) {</span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="co">###### Call Gradient #####################################</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="co"># We call the posteriors gradient at the current state of</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>  <span class="co"># our position momentum</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>  <span class="co"># In case of a GRM we need to specify design and target</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>  args &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw">is.null</span>(design) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">is.null</span>(target)) {</span>
<span id="cb8-9"><a href="#cb8-9"></a>    <span class="kw">list</span>(position_momentum<span class="op">$</span>position)</span>
<span id="cb8-10"><a href="#cb8-10"></a>  } <span class="cf">else</span> <span class="kw">list</span>(position_momentum<span class="op">$</span>position, design, target)</span>
<span id="cb8-11"><a href="#cb8-11"></a>  gradient_step &lt;-<span class="st"> </span><span class="kw">do.call</span>(gradient, args)</span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="co">###### Leapfrog Step ####################################</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>  <span class="co"># From our actual position:</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>  <span class="co"># We do one Leapfrog step to the sampled direction</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="co"># This step is largely determined by the gradient</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>  step &lt;-<span class="st"> </span><span class="kw">leapfrog</span>(position_momentum<span class="op">$</span>position,</span>
<span id="cb8-17"><a href="#cb8-17"></a>                   position_momentum<span class="op">$</span>momentum,</span>
<span id="cb8-18"><a href="#cb8-18"></a>                   <span class="dt">stepsize =</span> (direction <span class="op">*</span><span class="st"> </span>stepsize),</span>
<span id="cb8-19"><a href="#cb8-19"></a>                   <span class="dt">gradient =</span> gradient_step)</span>
<span id="cb8-20"><a href="#cb8-20"></a>  <span class="co">###### Return State #######################################</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>  <span class="co"># We create a new state containing our leapfrog step as</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>  <span class="co"># rightmost, leftmost and current state</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>  <span class="co"># We calculate the likelihood of our (unnormalized)</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>  <span class="co"># joint probability at our current state</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>  <span class="co"># if this is more likely than the slice drawn from state of</span></span>
<span id="cb8-26"><a href="#cb8-26"></a>  <span class="co"># the previous iteration, current state is assigned as valid state</span></span>
<span id="cb8-27"><a href="#cb8-27"></a>  <span class="co"># Additionally we check if simulation error didn&#39;t increase too much</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>  proposal_state &lt;-<span class="st"> </span><span class="kw">do.call</span>(initialize_state, step)</span>
<span id="cb8-29"><a href="#cb8-29"></a>  proposal_density &lt;-<span class="st"> </span><span class="kw">do.call</span>(joint_probability, <span class="kw">c</span>(step, design, target,</span>
<span id="cb8-30"><a href="#cb8-30"></a>                                                   <span class="st">&quot;is_log&quot;</span> =<span class="st"> </span>is_log))</span>
<span id="cb8-31"><a href="#cb8-31"></a>  valid &lt;-<span class="st"> </span>slice <span class="op">&lt;=</span><span class="st"> </span><span class="kw">exp</span>(proposal_density)</span>
<span id="cb8-32"><a href="#cb8-32"></a>  <span class="cf">if</span>(valid) proposal_state<span class="op">$</span>valid_state &lt;-<span class="st"> </span>step</span>
<span id="cb8-33"><a href="#cb8-33"></a>  proposal_state<span class="op">$</span>run &lt;-<span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>(proposal_density <span class="op">&gt;</span><span class="st"> </span><span class="kw">log</span>(slice) <span class="op">-</span><span class="st"> </span>deltamax)</span>
<span id="cb8-34"><a href="#cb8-34"></a>  proposal_state</span>
<span id="cb8-35"><a href="#cb8-35"></a>}</span></code></pre></div>
</section><section id="implement-build-trees---doubled-recurion" class="slide level2">
<h2>Implement Build Trees - Doubled Recurion</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co">#&#39; Build Trees doubles the positions and momentum and such the trajectory length</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co">#&#39;</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">#&#39; Repeatedly called by NUTS until run == FALSE, that is when a U-Turn is performed.</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">#&#39;</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#&#39; @param position_momentum list, containing actual position and momentum</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co">#&#39; @param slice drawn slice sample to validate position-/momentum steps</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co">#&#39; @param direction determines whether trajectory should explore forwards or backwards</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co">#&#39; @param tree_depth balanced tree depth with momentum and position states in the tree nodes</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">#&#39; @param is_log logical, indicator if joint probability is already logged</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="co">#&#39; @param stepsize parsed stepsize \epsilon to Leapfrog step function</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="co">#&#39; @param design design matrix of features for linear modell</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="co">#&#39; @param target target variable to validate predictions</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="co">#&#39; @param deltamax stop if the error in simulation increases</span></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="co">#&#39; @param run independent argument that tells build tree if stopping criteria is met</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="co">#&#39; @param valid_states all valid states visited so far</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="co">#&#39;</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>build_tree_simply &lt;-<span class="st"> </span><span class="cf">function</span>(position_momentum, slice, direction, tree_depth,</span>
<span id="cb9-18"><a href="#cb9-18"></a>                              is_log, stepsize, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>,</span>
<span id="cb9-19"><a href="#cb9-19"></a>                              <span class="dt">deltamax =</span> 1000L, <span class="dt">run =</span> <span class="dv">1</span>,</span>
<span id="cb9-20"><a href="#cb9-20"></a>                              <span class="dt">valid_states =</span> <span class="kw">structure</span>(<span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> 2L))) {</span>
<span id="cb9-21"><a href="#cb9-21"></a>  <span class="co">###### Base Case ###########################################</span></span>
<span id="cb9-22"><a href="#cb9-22"></a>  <span class="co"># if tree_depth is zero: Call build leaf,</span></span>
<span id="cb9-23"><a href="#cb9-23"></a>  <span class="co"># take one leapfrog step into direction</span></span>
<span id="cb9-24"><a href="#cb9-24"></a>  <span class="cf">if</span>(tree_depth <span class="op">==</span><span class="st"> </span>0L) {</span>
<span id="cb9-25"><a href="#cb9-25"></a>    <span class="kw">build_leaf</span>(position_momentum, slice, direction, tree_depth,</span>
<span id="cb9-26"><a href="#cb9-26"></a>               <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb9-27"><a href="#cb9-27"></a>               <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log)</span>
<span id="cb9-28"><a href="#cb9-28"></a>  } <span class="cf">else</span> {</span>
<span id="cb9-29"><a href="#cb9-29"></a>    <span class="co">###### Recursion ###########################################</span></span>
<span id="cb9-30"><a href="#cb9-30"></a>    <span class="co"># Recursion- build left/right subtrees</span></span>
<span id="cb9-31"><a href="#cb9-31"></a>    <span class="co"># Call build_tree at tree_depth - 1 twice</span></span>
<span id="cb9-32"><a href="#cb9-32"></a>    <span class="co"># leapfrogsteps will get called 2^treedepth times</span></span>
<span id="cb9-33"><a href="#cb9-33"></a>    state &lt;-<span class="st"> </span><span class="kw">build_tree</span>(position_momentum, slice, direction, tree_depth <span class="op">-</span><span class="st"> </span>1L,</span>
<span id="cb9-34"><a href="#cb9-34"></a>                        <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb9-35"><a href="#cb9-35"></a>                        <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">run =</span> run,</span>
<span id="cb9-36"><a href="#cb9-36"></a>                        <span class="dt">valid_states =</span> valid_states)</span>
<span id="cb9-37"><a href="#cb9-37"></a>    <span class="co"># After calling the second build_tree, assign depending on</span></span>
<span id="cb9-38"><a href="#cb9-38"></a>    <span class="co"># direction left or rightmost node to state, which will be returned</span></span>
<span id="cb9-39"><a href="#cb9-39"></a>    <span class="cf">if</span>(direction <span class="op">==</span><span class="st"> </span><span class="op">-</span>1L) {</span>
<span id="cb9-40"><a href="#cb9-40"></a>      state1 &lt;-<span class="st"> </span><span class="kw">build_tree</span>(state<span class="op">$</span>leftmost, slice, direction, tree_depth <span class="op">-</span><span class="st"> </span>1L,</span>
<span id="cb9-41"><a href="#cb9-41"></a>                           <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb9-42"><a href="#cb9-42"></a>                           <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">run =</span> run,</span>
<span id="cb9-43"><a href="#cb9-43"></a>                           <span class="dt">valid_states =</span> valid_states)</span>
<span id="cb9-44"><a href="#cb9-44"></a>      state<span class="op">$</span>leftmost &lt;-<span class="st"> </span>state1<span class="op">$</span>leftmost</span>
<span id="cb9-45"><a href="#cb9-45"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-46"><a href="#cb9-46"></a>      state1 &lt;-<span class="st"> </span><span class="kw">build_tree</span>(state<span class="op">$</span>rightmost, slice, direction, tree_depth <span class="op">-</span><span class="st"> </span>1L,</span>
<span id="cb9-47"><a href="#cb9-47"></a>                           <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb9-48"><a href="#cb9-48"></a>                           <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">run =</span> run,</span>
<span id="cb9-49"><a href="#cb9-49"></a>                           <span class="dt">valid_states =</span> valid_states)</span>
<span id="cb9-50"><a href="#cb9-50"></a>      state<span class="op">$</span>rightmost &lt;-<span class="st"> </span>state1<span class="op">$</span>rightmost</span>
<span id="cb9-51"><a href="#cb9-51"></a>    }</span>
<span id="cb9-52"><a href="#cb9-52"></a>  }</span>
<span id="cb9-53"><a href="#cb9-53"></a>}</span></code></pre></div>
</section><section id="example---recursion-with-tree_depth-3" class="slide level2">
<h2>Example - Recursion with <code>tree_depth = 3</code></h2>
<center>
<img data-src="files/recursion.svg" /><!-- -->
</center>
</section><section id="implement-build-trees---update-state" class="slide level2">
<h2>Implement Build Trees - Update State</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co">#&#39; Build Trees doubles the positions and momentum and such the trajectory length</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">#&#39;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">#&#39; Repeatedly called by NUTS until run == FALSE, that is when a U-Turn is performed.</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co">#&#39;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co">#&#39; @param position_momentum list, containing actual position and momentum</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co">#&#39; @param slice drawn slice sample to validate position-/momentum steps</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co">#&#39; @param direction determines whether trajectory should explore forwards or backwards</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="co">#&#39; @param tree_depth balanced tree depth with momentum and position states in the tree nodes</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co">#&#39; @param is_log logical, indicator if joint probability is already logged</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="co">#&#39; @param stepsize parsed stepsize \epsilon to Leapfrog step function</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co">#&#39; @param design design matrix of features for linear modell</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="co">#&#39; @param target target variable to validate predictions</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="co">#&#39; @param deltamax stop if the error in simulation increases</span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="co">#&#39; @param run independent argument that tells build tree if stopping criteria is met</span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="co">#&#39; @param valid_states all valid states visited so far</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="co">#&#39;</span></span>
<span id="cb10-17"><a href="#cb10-17"></a>build_tree_simply &lt;-<span class="st"> </span><span class="cf">function</span>(position_momentum, slice, direction, tree_depth,</span>
<span id="cb10-18"><a href="#cb10-18"></a>                              is_log, stepsize, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>,</span>
<span id="cb10-19"><a href="#cb10-19"></a>                              <span class="dt">deltamax =</span> 1000L, <span class="dt">run =</span> <span class="dv">1</span>,</span>
<span id="cb10-20"><a href="#cb10-20"></a>                              <span class="dt">valid_states =</span> <span class="kw">structure</span>(<span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="dt">length =</span> 2L))) {</span>
<span id="cb10-21"><a href="#cb10-21"></a>  <span class="co">###### Base Case ###########################################</span></span>
<span id="cb10-22"><a href="#cb10-22"></a>  <span class="co"># if tree_depth is zero: Call build leaf,</span></span>
<span id="cb10-23"><a href="#cb10-23"></a>  <span class="co"># take one leapfrog step into direction</span></span>
<span id="cb10-24"><a href="#cb10-24"></a>  <span class="cf">if</span>(tree_depth <span class="op">==</span><span class="st"> </span>0L) {</span>
<span id="cb10-25"><a href="#cb10-25"></a>    <span class="kw">build_leaf</span>(position_momentum, slice, direction, tree_depth,</span>
<span id="cb10-26"><a href="#cb10-26"></a>               <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb10-27"><a href="#cb10-27"></a>               <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log)</span>
<span id="cb10-28"><a href="#cb10-28"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-29"><a href="#cb10-29"></a>    <span class="co">###### Recursion ###########################################</span></span>
<span id="cb10-30"><a href="#cb10-30"></a>    <span class="co"># Recursion- build left/right subtrees</span></span>
<span id="cb10-31"><a href="#cb10-31"></a>    <span class="co"># Call build_tree at tree_depth - 1 twice</span></span>
<span id="cb10-32"><a href="#cb10-32"></a>    <span class="co"># leapfrogsteps will get called 2^treedepth times</span></span>
<span id="cb10-33"><a href="#cb10-33"></a>    state &lt;-<span class="st"> </span><span class="kw">build_tree</span>(position_momentum, slice, direction, tree_depth <span class="op">-</span><span class="st"> </span>1L,</span>
<span id="cb10-34"><a href="#cb10-34"></a>                        <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb10-35"><a href="#cb10-35"></a>                        <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">run =</span> run,</span>
<span id="cb10-36"><a href="#cb10-36"></a>                        <span class="dt">valid_states =</span> valid_states)</span>
<span id="cb10-37"><a href="#cb10-37"></a>    <span class="co"># After calling the second build_tree, assign depending on</span></span>
<span id="cb10-38"><a href="#cb10-38"></a>    <span class="co"># direction left or rightmost node to state, which will be returned</span></span>
<span id="cb10-39"><a href="#cb10-39"></a>    <span class="cf">if</span>(direction <span class="op">==</span><span class="st"> </span><span class="op">-</span>1L) {</span>
<span id="cb10-40"><a href="#cb10-40"></a>      state1 &lt;-<span class="st"> </span><span class="kw">build_tree</span>(state<span class="op">$</span>leftmost, slice, direction, tree_depth <span class="op">-</span><span class="st"> </span>1L,</span>
<span id="cb10-41"><a href="#cb10-41"></a>                           <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb10-42"><a href="#cb10-42"></a>                           <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">run =</span> run,</span>
<span id="cb10-43"><a href="#cb10-43"></a>                           <span class="dt">valid_states =</span> valid_states)</span>
<span id="cb10-44"><a href="#cb10-44"></a>      state<span class="op">$</span>leftmost &lt;-<span class="st"> </span>state1<span class="op">$</span>leftmost</span>
<span id="cb10-45"><a href="#cb10-45"></a>    } <span class="cf">else</span> {</span>
<span id="cb10-46"><a href="#cb10-46"></a>      state1 &lt;-<span class="st"> </span><span class="kw">build_tree</span>(state<span class="op">$</span>rightmost, slice, direction, tree_depth <span class="op">-</span><span class="st"> </span>1L,</span>
<span id="cb10-47"><a href="#cb10-47"></a>                           <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb10-48"><a href="#cb10-48"></a>                           <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">run =</span> run,</span>
<span id="cb10-49"><a href="#cb10-49"></a>                           <span class="dt">valid_states =</span> valid_states)</span>
<span id="cb10-50"><a href="#cb10-50"></a>      state<span class="op">$</span>rightmost &lt;-<span class="st"> </span>state1<span class="op">$</span>rightmost</span>
<span id="cb10-51"><a href="#cb10-51"></a>    }</span>
<span id="cb10-52"><a href="#cb10-52"></a>    <span class="co">###### Return State #######################################</span></span>
<span id="cb10-53"><a href="#cb10-53"></a>    <span class="co"># Check if any stopping criteria was met during recursion</span></span>
<span id="cb10-54"><a href="#cb10-54"></a>    <span class="co"># update valid states by unioning states from both build</span></span>
<span id="cb10-55"><a href="#cb10-55"></a>    <span class="co"># tree calls</span></span>
<span id="cb10-56"><a href="#cb10-56"></a>    run &lt;-<span class="st"> </span>run <span class="op">*</span><span class="st"> </span>state1<span class="op">$</span>run <span class="op">*</span><span class="st"> </span>state<span class="op">$</span>run <span class="op">*</span><span class="st"> </span><span class="kw">is_U_turn</span>(state)</span>
<span id="cb10-57"><a href="#cb10-57"></a>    state<span class="op">$</span>run &lt;-<span class="st"> </span>run</span>
<span id="cb10-58"><a href="#cb10-58"></a>    valid_states<span class="op">$</span>position &lt;-<span class="st"> </span><span class="kw">rbind</span>(valid_states<span class="op">$</span>position,</span>
<span id="cb10-59"><a href="#cb10-59"></a>                                   state<span class="op">$</span>valid_state<span class="op">$</span>position,</span>
<span id="cb10-60"><a href="#cb10-60"></a>                                   state1<span class="op">$</span>valid_state<span class="op">$</span>position)</span>
<span id="cb10-61"><a href="#cb10-61"></a>    valid_states<span class="op">$</span>momentum &lt;-<span class="st"> </span><span class="kw">rbind</span>(valid_states<span class="op">$</span>momentum,</span>
<span id="cb10-62"><a href="#cb10-62"></a>                                   state<span class="op">$</span>valid_state<span class="op">$</span>momentum,</span>
<span id="cb10-63"><a href="#cb10-63"></a>                                   state1<span class="op">$</span>valid_state<span class="op">$</span>momentum)</span>
<span id="cb10-64"><a href="#cb10-64"></a>    state<span class="op">$</span>valid_state<span class="op">$</span>position &lt;-<span class="st"> </span>valid_states<span class="op">$</span>position</span>
<span id="cb10-65"><a href="#cb10-65"></a>    state<span class="op">$</span>valid_state<span class="op">$</span>momentum &lt;-<span class="st"> </span>valid_states<span class="op">$</span>momentum</span>
<span id="cb10-66"><a href="#cb10-66"></a>    <span class="kw">return</span>(state)</span>
<span id="cb10-67"><a href="#cb10-67"></a>  }</span>
<span id="cb10-68"><a href="#cb10-68"></a>}</span></code></pre></div>
</section></section>
<section><section id="section-3" class="title-slide slide level1" data-background="#262626"><h1></h1><h1 style="color: #fff" class="r-fit-text">
The efficient No-U-Turn Sampler
</h1>
<center>
<img src="files/nNuts.png" width="876" />
</center></section><section id="problems-of-naive-nuts" class="slide level2">
<h2>Problems of naive NUTS</h2>
<p>Recall the example trajectory:</p>
<div class="fragment">
<center>
<div class="figure">
<img src="files/trajectory.png" alt="Example of a trajectory generated during one iteration of NUTS." width="50%" />
<p class="caption">
Example of a trajectory generated during one iteration of NUTS.
</p>
</div>
</center>
</div>
<ul>
<li class="fragment">Problem 1: waste of posterior and gradient computations</li>
</ul>
<ul>
<li class="fragment">Problem 2: large amount of memory: Storing <span class="math inline">\(2^j\)</span> position-momentum states</li>
</ul>
<ul>
<li class="fragment">Problem 3: if stopping is met in the middle of a run there is no need for further evaluations</li>
</ul>
</section><section id="efficient-nuts---a-solution" class="slide level2">
<h2>Efficient NUTS - a solution</h2>
<p><br><br> Idea: <br></p>
<ul>
<li><p>Therefore sample from <span class="math inline">\(\mathcal{C}\)</span> incrementally by its subtrees</p></li>
<li><p>Quit early if any stopping criteria is met</p></li>
</ul>
<div class="fragment">
<p>For each subtree <span class="math inline">\(\mathcal{B_{st}}\)</span> in <span class="math inline">\(\mathcal{B}\)</span>:</p>
</div>
<ul>
<li class="fragment">sample a valid state <span class="math inline">\((\theta, r) \in \mathcal{C_{st}}\)</span> as representee</li>
</ul>
<ul>
<li class="fragment">choose a pair by giving them a weight proportional to their subtrees element size</li>
</ul>
<div class="fragment">
<p><strong>this method </strong></p>
</div>
<div class="fragment">
<p><span class="math inline">\(\Rightarrow\)</span> stores only <span class="math inline">\(\mathcal{O}(j)\)</span> position momentum vectors and</p>
<p><span class="math inline">\(\Rightarrow\)</span> is sparse at calculating the gradient as build tree can be canceled early if U-turn was made</p>
</div>
</section><section id="differences-to-naive-nuts" class="slide level2">
<h2>Differences to naive NUTS</h2>
<center>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:600px; ">
<table class=" lightable-paper" style='font-family: "Arial Narrow", arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;'>
<thead>
<tr>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
name
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
logo
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Dif NUTS
</td>
<td style="text-align:left;">
<img src="files/git_Dif_NUTS.png">
</td>
</tr>
<tr>
<td style="text-align:left;">
Dif build_tree
</td>
<td style="text-align:left;">
<img src="files/git_Dif_build_Tree.png">
</td>
</tr>
<tr>
<td style="text-align:left;">
Dif build leaf
</td>
<td style="text-align:left;">
<img src="files/git_Dif_leaf.png">
</td>
</tr>
</tbody>
</table>
</div>
</center>
</section></section>
<section><section id="section-4" class="title-slide slide level1" data-background="#262626"><h1></h1><h1 style="color: #fff" class="r-fit-text">
No-U-Turn Sampler with dual averaging
</h1>
<center>
<img src="files/NUTS.png" width="876" />
</center></section><section id="intuition" class="slide level2">
<h2>Intuition</h2>
<p><br></p>
<ul>
<li class="fragment">Acceptance probability for this, would be one if we could exactly run the hamiltonian dynamics as it drives us towards lower density regions.</li>
</ul>
<div class="fragment">
<p><span class="math inline">\(\Rightarrow\)</span> Essentially, this acceptance probability is related to how good the numerical approximation of Leapfrogsteps to the Hamiltonian dynamics is.</p>
</div>
<ul>
<li class="fragment">Then, we balance the tradeoff between the error and the time it takes to generate any given sample by varying <span class="math inline">\(\delta\)</span> either spend more time generating better approximations of the Hamiltonian-dynamics, or alternately spend less time generating crappier ones knowing that we will throw more away.</li>
</ul>
<div class="fragment">
<center>
<img src="files/Leapfrog_Discretization.png" width="75%" />
<center>
</div>
</section><section id="adaptively-tuning-the-stepsize" class="slide level2">
<h2>Adaptively tuning the stepsize</h2>
<br>
<div class="fragment">
<p>Idea: Find a <strong>stepsize</strong> <span class="math inline">\(\epsilon\)</span> in a Warm-Up Phase that guarantees quick convergence Set this value in a Stationary Phase to make the algorithm converge</p>
</div>
<div class="fragment">
<p><em>Suppose</em> we aim for a target average acceptance probability <span class="math inline">\(\delta (= 0.65)\)</span>.</p>
<p><em>Suppose</em> our average acceptance at iteration t is <span class="math inline">\(\alpha_t\)</span></p>
<p>Let <span class="math inline">\(H_t = \delta - \alpha_t\)</span> then be our MCMC behavior at iteration t</p>
<p><em>Goal:</em> reach <span class="math inline">\(H_t \approx 0\)</span></p>
</div>
<div class="fragment">
<p><em>Update</em> <span class="math inline">\(\epsilon\)</span> as follows:</p>
<p><span class="math inline">\(\epsilon_{t+1} =\epsilon_t - \eta_tH_t, \ \eta_t \in (0,1]\)</span></p>
</div>
<div class="fragment">
<p>If acceptance <span class="math inline">\(\alpha_t\)</span> was to high we encourage the algorithm for larger jumps, rising <span class="math inline">\(\epsilon_{t+1}\)</span></p>
<p>If acceptance <span class="math inline">\(\alpha_t\)</span> was to low we encourage the algorithm for smaller jumps, decreasing <span class="math inline">\(\epsilon_{t+1}\)</span></p>
</div>
</section><section id="dual-averaging" class="slide level2">
<h2>Dual Averaging</h2>
<p><strong>Problem:</strong> Usually parameters are quite different between Warm-Up and Stationary phase.</p>
<p><span class="math inline">\(\Rightarrow\)</span> We want the stepsize to adapt quickly as we shift from Warm-Up to stationary Phase</p>
<div class="fragment">
<p><span class="math display">\[
H^t = (1 - \frac{1}{t_0 + t}) H^{t-1} + \frac{1}{t_0 + t} (\delta - \frac{\alpha}{n_{\alpha}})\\
log(\epsilon^t) = \mu - \frac{\sqrt{t}}{\gamma} H^t \\
log(\overline{\epsilon}^t) =t^{-\kappa} \epsilon^t + (1-t^{-\kappa}) \overline{\epsilon}^{t-1}
\]</span></p>
</div>
<ul>
<li class="fragment"><span class="math inline">\(t\)</span> is the iteration we are at</li>
</ul>
<ul>
<li class="fragment"><span class="math inline">\(t_0\)</span> stabilizes <span class="math inline">\(H^t\)</span> in early iterations (default: 10L)</li>
</ul>
<ul>
<li class="fragment"><span class="math inline">\(\epsilon^t\)</span> epsilon at itaeration t (this is the next iteration here)</li>
</ul>
<ul>
<li class="fragment"><span class="math inline">\(\mu\)</span> freely choosen value where we shrink towards (default: <span class="math inline">\(log(10\epsilon^1)\)</span>, which encourages the algorithm for larger <span class="math inline">\(\epsilon\)</span>)</li>
</ul>
<ul>
<li class="fragment"><span class="math inline">\(\gamma\)</span> controls the amount of shrinkage (default: 0.05)</li>
</ul>
<ul>
<li class="fragment"><span class="math inline">\(t^{-\kappa}\)</span> stepsize schedual: increases the influence of more recent iterations</li>
</ul>
<div class="fragment">
<p>We use <span class="math inline">\(\epsilon^t\)</span> in Warm-Up phase for <span class="math inline">\(M_{adapt}\)</span> iterations, and <span class="math inline">\(\overline{\epsilon}^{M_{adapt}}\)</span> for the stationary phase.</p>
<p><span class="math inline">\(\epsilon^t\)</span> allows the algorithm in Warm Up Phase to adapt quickly</p>
<p><span class="math inline">\(\overline{\epsilon}^{M_{adapt}}\)</span> ensures a stable stepsize in stationary phase that favors more recent iterations from Warm Up phase</p>
</div>
</section><section id="dual-averaging-in-nuts" class="slide level2">
<h2>Dual Averaging in NUTS</h2>
<p>Problem: As NUTS has no clarified acceptance/rejection step we need to specify this step on our own</p>
<p>So we have to recalculate acceptance:</p>
<div class="fragment">
<p><span class="math display">\[
\begin{aligned}
\alpha_t^{NUTS} &amp; = \frac{1}{|\mathcal{B_t^{final}}|}\sum_{(\theta, r) \in \mathcal{B_t^{final}}} min(1, \frac{p(\theta, r)}{p(\theta^{t-1}, r^{t-1})})
\end{aligned}
\]</span></p>
</div>
<div class="fragment">
<p>Integration in <code>build_leaf</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># ______________________________________________________________________________</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co">#&#39; Build One Tree</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">#&#39;</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">#&#39; Builds one tree doing a leapfrogstep in one direction</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co">#&#39;</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co">#&#39; @inheritParams build_tree</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>build_leaf &lt;-<span class="st"> </span><span class="cf">function</span>(position_momentum, slice, direction, tree_depth, stepsize, deltamax,</span>
<span id="cb11-8"><a href="#cb11-8"></a>                       <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>, <span class="dt">iter =</span> <span class="ot">NULL</span>, is_log) {</span>
<span id="cb11-9"><a href="#cb11-9"></a>  args &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw">is.null</span>(design) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">is.null</span>(target)) {</span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="kw">list</span>(position_momentum<span class="op">$</span>position)</span>
<span id="cb11-11"><a href="#cb11-11"></a>  } <span class="cf">else</span> <span class="kw">list</span>(position_momentum<span class="op">$</span>position, design, target)</span>
<span id="cb11-12"><a href="#cb11-12"></a>  gradient_step &lt;-<span class="st"> </span><span class="kw">do.call</span>(gradient, args)</span>
<span id="cb11-13"><a href="#cb11-13"></a>  step &lt;-<span class="st"> </span><span class="kw">leapfrog</span>(position_momentum<span class="op">$</span>position, position_momentum<span class="op">$</span>momentum,</span>
<span id="cb11-14"><a href="#cb11-14"></a>                   <span class="dt">stepsize =</span> (direction <span class="op">*</span><span class="st"> </span>stepsize), <span class="dt">gradient =</span> gradient_step)</span>
<span id="cb11-15"><a href="#cb11-15"></a>  proposal_state &lt;-<span class="st"> </span><span class="kw">do.call</span>(initialize_state, <span class="kw">c</span>(step, <span class="st">&quot;efficient&quot;</span> =<span class="st"> </span><span class="op">!</span><span class="kw">is.null</span>(iter)))</span>
<span id="cb11-16"><a href="#cb11-16"></a>  proposal_density &lt;-<span class="st"> </span><span class="kw">do.call</span>(joint_probability, <span class="kw">c</span>(step, <span class="kw">list</span>(design), <span class="kw">list</span>(target), <span class="st">&quot;is_log&quot;</span> =<span class="st"> </span>is_log))</span>
<span id="cb11-17"><a href="#cb11-17"></a>  valid &lt;-<span class="st"> </span>slice <span class="op">&lt;=</span><span class="st"> </span><span class="kw">exp</span>(proposal_density)</span>
<span id="cb11-18"><a href="#cb11-18"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(iter)) {</span>
<span id="cb11-19"><a href="#cb11-19"></a>    proposal_state<span class="op">$</span>count &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(valid)</span>
<span id="cb11-20"><a href="#cb11-20"></a>    quotient_lik &lt;-<span class="st"> </span><span class="kw">exp</span>(proposal_density <span class="op">-</span><span class="st"> </span><span class="kw">do.call</span>(joint_probability, <span class="kw">c</span>(iter, <span class="kw">list</span>(design), <span class="kw">list</span>(target), <span class="st">&quot;is_log&quot;</span> =<span class="st"> </span>is_log)))</span>
<span id="cb11-21"><a href="#cb11-21"></a>    proposal_state<span class="op">$</span>acceptance<span class="op">$</span>acceptance &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="dv">1</span>, quotient_lik)</span>
<span id="cb11-22"><a href="#cb11-22"></a>    proposal_state<span class="op">$</span>valid_state &lt;-<span class="st"> </span>step</span>
<span id="cb11-23"><a href="#cb11-23"></a>  }</span>
<span id="cb11-24"><a href="#cb11-24"></a>  proposal_state<span class="op">$</span>run &lt;-<span class="st"> </span><span class="cf">if</span>(slice <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>(<span class="kw">exp</span>(proposal_density <span class="op">+</span><span class="st"> </span>deltamax) <span class="op">&gt;</span><span class="st"> </span>slice) <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb11-25"><a href="#cb11-25"></a>  proposal_state</span>
<span id="cb11-26"><a href="#cb11-26"></a>}</span></code></pre></div>
</div>
</section><section id="find-initial-stepsize" class="slide level2">
<h2>Find initial stepsize</h2>
<ul>
<li class="fragment">Dual averaging works for any given starting value <span class="math inline">\(\epsilon_1\)</span></li>
</ul>
<ul>
<li class="fragment">However we can speed up convergence by choosing a propper <span class="math inline">\(\epsilon_1\)</span></li>
</ul>
<ul>
<li class="fragment">We constantly double/halve proposal <span class="math inline">\(\epsilon_1\)</span> until the acceptance rate of our proposal crosses 0.5 or 2</li>
</ul>
<ul>
<li class="fragment">For low exceptance we encourage the algorithm for small cautious steps</li>
</ul>
<ul>
<li class="fragment">For high exceptance we encourage the algorithm for large ambitious steps</li>
</ul>
<div class="fragment">
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">#&#39; Find A Reasonable initial value for stepsize parameter</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="co">#&#39;</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="co">#&#39; supplement to dual averaging to speed up convergence by initializing a reasonable stepsize via heuristic</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="co">#&#39;</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="co">#&#39; @inheritParams nouturn_sampler</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>find_initial_stepsize &lt;-<span class="st"> </span><span class="cf">function</span>(position_init, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>, is_log) {</span>
<span id="cb12-7"><a href="#cb12-7"></a>  stepsize &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>  momentum &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(position_init))</span>
<span id="cb12-9"><a href="#cb12-9"></a>  args &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw">is.null</span>(design) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">is.null</span>(target)) {</span>
<span id="cb12-10"><a href="#cb12-10"></a>    <span class="kw">list</span>(<span class="st">&quot;pos&quot;</span> =<span class="st"> </span>position_init)</span>
<span id="cb12-11"><a href="#cb12-11"></a>  } <span class="cf">else</span> <span class="kw">list</span>(<span class="st">&quot;pos&quot;</span> =<span class="st"> </span>position_init, <span class="st">&quot;des&quot;</span> =<span class="st"> </span>design, <span class="st">&quot;tar&quot;</span> =<span class="st"> </span>target)</span>
<span id="cb12-12"><a href="#cb12-12"></a>  gradient_step &lt;-<span class="st"> </span><span class="kw">do.call</span>(gradient, args)</span>
<span id="cb12-13"><a href="#cb12-13"></a>  proposal &lt;-<span class="st"> </span><span class="kw">leapfrog</span>(position_init, momentum, stepsize, gradient_step)</span>
<span id="cb12-14"><a href="#cb12-14"></a>  exponent &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(<span class="kw">acceptance_rate</span>(args, momentum, proposal, is_log) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">-</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>  <span class="cf">while</span>(<span class="kw">acceptance_rate</span>(args, momentum, proposal, is_log)<span class="op">^</span>exponent <span class="op">&gt;</span><span class="st"> </span><span class="dv">2</span><span class="op">^</span>(<span class="op">-</span>exponent)) {</span>
<span id="cb12-16"><a href="#cb12-16"></a>    stepsize &lt;-<span class="st"> </span>stepsize <span class="op">*</span><span class="st"> </span><span class="dv">2</span><span class="op">^</span>exponent</span>
<span id="cb12-17"><a href="#cb12-17"></a>    proposal &lt;-<span class="st"> </span><span class="kw">leapfrog</span>(position_init, momentum, stepsize, gradient_step)</span>
<span id="cb12-18"><a href="#cb12-18"></a>  }</span>
<span id="cb12-19"><a href="#cb12-19"></a>  stepsize</span>
<span id="cb12-20"><a href="#cb12-20"></a>}</span>
<span id="cb12-21"><a href="#cb12-21"></a><span class="co"># ______________________________________________________________________________</span></span>
<span id="cb12-22"><a href="#cb12-22"></a>acceptance_rate &lt;-<span class="st"> </span><span class="cf">function</span>(args, momentum, proposal, is_log) {</span>
<span id="cb12-23"><a href="#cb12-23"></a>  proposal_dens &lt;-<span class="st"> </span><span class="kw">joint_probability</span>(proposal[[<span class="dv">1</span>]], proposal[[<span class="dv">2</span>]], args<span class="op">$</span>des, args<span class="op">$</span>tar, is_log)</span>
<span id="cb12-24"><a href="#cb12-24"></a>  initial_dens &lt;-<span class="st"> </span><span class="kw">joint_probability</span>(args<span class="op">$</span>pos, momentum, args<span class="op">$</span>des, args<span class="op">$</span>tar, is_log)</span>
<span id="cb12-25"><a href="#cb12-25"></a>  <span class="kw">exp</span>(proposal_dens <span class="op">-</span><span class="st"> </span>initial_dens)</span>
<span id="cb12-26"><a href="#cb12-26"></a>}</span></code></pre></div>
</div>
</section><section id="implement-efficient-nuts-with-dual-averaging" class="slide level2">
<h2>Implement efficient NUTS with dual averaging</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">#&#39; Efficient No-UTurn</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co">#&#39;</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co">#&#39; Efficient No-U-turn Sampler, implemented by Gelman et al. 2013</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co">#&#39; it is possible to determine stepsize by dual averaging</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">#&#39;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">#&#39; @inheritParams naive_nouturn_sampler</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">#&#39; @param adaption iterations where  stepsize is adapted. Must be smaller than iterations.</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">#&#39; @param target_accpentance targeted average acceptance rate of proposals</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="co">#&#39;</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>sample_noUturn_s &lt;-<span class="st"> </span><span class="cf">function</span>(position_init, iteration,</span>
<span id="cb13-11"><a href="#cb13-11"></a>                           <span class="dt">adaption =</span> <span class="fl">0.5</span> <span class="op">*</span><span class="st"> </span>iteration, <span class="dt">target_accpentance =</span> <span class="fl">0.65</span>,</span>
<span id="cb13-12"><a href="#cb13-12"></a>                           <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>, <span class="dt">is_log =</span> <span class="ot">TRUE</span>, <span class="dt">max_tree_depth =</span> 10L) {</span>
<span id="cb13-13"><a href="#cb13-13"></a>  stepsize &lt;-<span class="st"> </span><span class="kw">find_initial_stepsize</span>(position_init, design, target, is_log)</span>
<span id="cb13-14"><a href="#cb13-14"></a>  duala_params &lt;-<span class="st"> </span><span class="kw">init_parmeters</span>(stepsize)</span>
<span id="cb13-15"><a href="#cb13-15"></a>  position &lt;-<span class="st"> </span>position_init</span>
<span id="cb13-16"><a href="#cb13-16"></a>  positions &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="kw">length</span>(position_init), <span class="dt">nrow =</span> iteration))</span>
<span id="cb13-17"><a href="#cb13-17"></a>  <span class="cf">for</span>(m <span class="cf">in</span> <span class="kw">seq_len</span>(iteration)) {</span>
<span id="cb13-18"><a href="#cb13-18"></a>    momentum &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(position))</span>
<span id="cb13-19"><a href="#cb13-19"></a>    iter &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;position&quot;</span> =<span class="st"> </span>position, <span class="st">&quot;momentum&quot;</span> =<span class="st"> </span>momentum)</span>
<span id="cb13-20"><a href="#cb13-20"></a>    slice &lt;-<span class="st"> </span><span class="kw">runif</span>(1L, <span class="dt">max =</span> <span class="kw">exp</span>(<span class="kw">joint_probability</span>(position, momentum, design,</span>
<span id="cb13-21"><a href="#cb13-21"></a>                                                   target, <span class="dt">is_log =</span> is_log)))</span>
<span id="cb13-22"><a href="#cb13-22"></a>    <span class="co"># Initialize state to call on Build Tree</span></span>
<span id="cb13-23"><a href="#cb13-23"></a>    state &lt;-<span class="st"> </span><span class="kw">initialize_state</span>(position, momentum, <span class="dt">efficient =</span> <span class="ot">TRUE</span>)</span>
<span id="cb13-24"><a href="#cb13-24"></a>    state<span class="op">$</span>count &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb13-25"><a href="#cb13-25"></a>    tree_depth &lt;-<span class="st"> </span>0L</span>
<span id="cb13-26"><a href="#cb13-26"></a>    <span class="cf">while</span>(state<span class="op">$</span>run) {</span>
<span id="cb13-27"><a href="#cb13-27"></a>      <span class="co"># 1 means forward, -1 means backward doubling</span></span>
<span id="cb13-28"><a href="#cb13-28"></a>      direction &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span>1L, 1L), 1L)</span>
<span id="cb13-29"><a href="#cb13-29"></a>      <span class="cf">if</span>(direction <span class="op">==</span><span class="st"> </span><span class="dv">-1</span>) {</span>
<span id="cb13-30"><a href="#cb13-30"></a>        state_proposal &lt;-<span class="st"> </span><span class="kw">build_efficient_tree</span>(state<span class="op">$</span>leftmost, slice, direction,</span>
<span id="cb13-31"><a href="#cb13-31"></a>                                               tree_depth, <span class="dt">stepsize =</span> stepsize, <span class="dt">design =</span> design,</span>
<span id="cb13-32"><a href="#cb13-32"></a>                                               <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">iter =</span> iter)</span>
<span id="cb13-33"><a href="#cb13-33"></a>        state<span class="op">$</span>leftmost &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>leftmost</span>
<span id="cb13-34"><a href="#cb13-34"></a>      } <span class="cf">else</span>{</span>
<span id="cb13-35"><a href="#cb13-35"></a>        state_proposal &lt;-<span class="st"> </span><span class="kw">build_efficient_tree</span>(state<span class="op">$</span>rightmost, slice, direction,</span>
<span id="cb13-36"><a href="#cb13-36"></a>                                               tree_depth, <span class="dt">stepsize =</span> stepsize, <span class="dt">design =</span> design,</span>
<span id="cb13-37"><a href="#cb13-37"></a>                                               <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">iter =</span> iter)</span>
<span id="cb13-38"><a href="#cb13-38"></a>        state<span class="op">$</span>rightmost &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>rightmost</span>
<span id="cb13-39"><a href="#cb13-39"></a>      }</span>
<span id="cb13-40"><a href="#cb13-40"></a>      <span class="cf">if</span>(state_proposal<span class="op">$</span>run) {</span>
<span id="cb13-41"><a href="#cb13-41"></a>        rate &lt;-<span class="st"> </span><span class="kw">min</span>(state_proposal<span class="op">$</span>count <span class="op">/</span><span class="st"> </span>state<span class="op">$</span>count, <span class="dv">1</span>)</span>
<span id="cb13-42"><a href="#cb13-42"></a>        <span class="cf">if</span>(<span class="kw">rbinom</span>(<span class="dt">n =</span> <span class="dv">1</span>, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> rate)) state<span class="op">$</span>valid_state &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>valid_state</span>
<span id="cb13-43"><a href="#cb13-43"></a>      }</span>
<span id="cb13-44"><a href="#cb13-44"></a>      state<span class="op">$</span>count &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>count <span class="op">+</span><span class="st"> </span>state<span class="op">$</span>count</span>
<span id="cb13-45"><a href="#cb13-45"></a>      state<span class="op">$</span>run &lt;-<span class="st"> </span>state_proposal<span class="op">$</span>run <span class="op">*</span><span class="st"> </span><span class="kw">is_U_turn</span>(<span class="dt">state =</span> state)</span>
<span id="cb13-46"><a href="#cb13-46"></a>      <span class="cf">if</span>(tree_depth <span class="op">&gt;</span><span class="st"> </span>max_tree_depth){</span>
<span id="cb13-47"><a href="#cb13-47"></a>        <span class="kw">warning</span>(<span class="st">&quot;NUTS: Reached max tree depth&quot;</span>)</span>
<span id="cb13-48"><a href="#cb13-48"></a>        <span class="cf">break</span></span>
<span id="cb13-49"><a href="#cb13-49"></a>      }</span>
<span id="cb13-50"><a href="#cb13-50"></a>      tree_depth &lt;-<span class="st"> </span>tree_depth <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb13-51"><a href="#cb13-51"></a>    }</span>
<span id="cb13-52"><a href="#cb13-52"></a>    <span class="cf">if</span>(m <span class="op">&lt;=</span><span class="st"> </span>adaption) {</span>
<span id="cb13-53"><a href="#cb13-53"></a>      duala_params &lt;-<span class="st"> </span><span class="kw">update_stepsize</span>(duala_params, m, target_accpentance,</span>
<span id="cb13-54"><a href="#cb13-54"></a>                                      state_proposal<span class="op">$</span>acceptance<span class="op">$</span>acceptance <span class="op">/</span><span class="st"> </span>state_proposal<span class="op">$</span>acceptance<span class="op">$</span>nacceptance)</span>
<span id="cb13-55"><a href="#cb13-55"></a>      stepsize &lt;-<span class="st"> </span>duala_params<span class="op">$</span>stepsize[m <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]</span>
<span id="cb13-56"><a href="#cb13-56"></a>    }</span>
<span id="cb13-57"><a href="#cb13-57"></a>    <span class="cf">if</span>(m <span class="op">==</span><span class="st"> </span>adaption) {</span>
<span id="cb13-58"><a href="#cb13-58"></a>      stepsize &lt;-<span class="st"> </span>duala_params<span class="op">$</span>stepsize_weight[m <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]</span>
<span id="cb13-59"><a href="#cb13-59"></a>    }</span>
<span id="cb13-60"><a href="#cb13-60"></a>    tree_depths[m] &lt;-<span class="st"> </span>tree_depth <span class="op">-</span><span class="st"> </span>2L</span>
<span id="cb13-61"><a href="#cb13-61"></a>    <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(state<span class="op">$</span>valid_state<span class="op">$</span>position)) position &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(state<span class="op">$</span>valid_state<span class="op">$</span>position)</span>
<span id="cb13-62"><a href="#cb13-62"></a>    positions[m, ] &lt;-<span class="st"> </span>position</span>
<span id="cb13-63"><a href="#cb13-63"></a>  }</span>
<span id="cb13-64"><a href="#cb13-64"></a>  <span class="kw">structure</span>(positions, <span class="st">&quot;tree_depth&quot;</span> =<span class="st"> </span>tree_depths,</span>
<span id="cb13-65"><a href="#cb13-65"></a>            <span class="st">&quot;dual_averaging&quot;</span> =<span class="st"> </span>duala_params)</span>
<span id="cb13-66"><a href="#cb13-66"></a>}</span></code></pre></div>
</section><section id="build-efficient-tree-and-leaves" class="slide level2">
<h2>Build efficient tree and leaves</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>build_efficient_tree_simply &lt;-<span class="st"> </span><span class="cf">function</span>(position_momentum, slice, direction, tree_depth,</span>
<span id="cb14-2"><a href="#cb14-2"></a>                                 iter, is_log, stepsize, <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>, <span class="dt">deltamax =</span> <span class="fl">1e50</span>,</span>
<span id="cb14-3"><a href="#cb14-3"></a>                                 <span class="dt">run =</span> <span class="dv">1</span>, <span class="dt">count =</span> <span class="dv">0</span>, <span class="dt">acceptance =</span> <span class="dv">0</span>, <span class="dt">nacceptance =</span> <span class="dv">0</span>) {</span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="cf">if</span>(tree_depth <span class="op">==</span><span class="st"> </span>0L) {<span class="co"># Basecase - take one leapfrogstep into direction</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="kw">build_leaf</span>(position_momentum, slice, direction, tree_depth, stepsize, deltamax,</span>
<span id="cb14-6"><a href="#cb14-6"></a>               <span class="dt">design =</span> design, <span class="dt">target =</span> target, <span class="dt">iter =</span> iter, <span class="dt">is_log =</span> is_log)</span>
<span id="cb14-7"><a href="#cb14-7"></a>  } <span class="cf">else</span> {<span class="co"># Recursion- build left/right subtrees</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>    state &lt;-<span class="st"> </span><span class="kw">build_efficient_tree</span>(position_momentum, slice, direction, tree_depth <span class="op">-</span><span class="st"> </span>1L,</span>
<span id="cb14-9"><a href="#cb14-9"></a>                                  <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb14-10"><a href="#cb14-10"></a>                                  <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">iter =</span> iter,</span>
<span id="cb14-11"><a href="#cb14-11"></a>                                  <span class="dt">run =</span> run, <span class="dt">count =</span> count,</span>
<span id="cb14-12"><a href="#cb14-12"></a>                                  <span class="dt">acceptance =</span> acceptance, <span class="dt">nacceptance =</span> nacceptance)</span>
<span id="cb14-13"><a href="#cb14-13"></a>    <span class="cf">if</span>(state<span class="op">$</span>run){</span>
<span id="cb14-14"><a href="#cb14-14"></a>      <span class="cf">if</span>(direction <span class="op">==</span><span class="st"> </span><span class="op">-</span>1L) {</span>
<span id="cb14-15"><a href="#cb14-15"></a>        state1 &lt;-<span class="st"> </span><span class="kw">build_efficient_tree</span>(state<span class="op">$</span>leftmost, slice, direction, tree_depth <span class="op">-</span><span class="st"> </span>1L,</span>
<span id="cb14-16"><a href="#cb14-16"></a>                                       <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb14-17"><a href="#cb14-17"></a>                                       <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">iter =</span> iter,</span>
<span id="cb14-18"><a href="#cb14-18"></a>                                       <span class="dt">run =</span> run, <span class="dt">count =</span> count,</span>
<span id="cb14-19"><a href="#cb14-19"></a>                                       <span class="dt">acceptance =</span> acceptance, <span class="dt">nacceptance =</span> nacceptance)</span>
<span id="cb14-20"><a href="#cb14-20"></a>        state<span class="op">$</span>leftmost &lt;-<span class="st"> </span>state1<span class="op">$</span>leftmost</span>
<span id="cb14-21"><a href="#cb14-21"></a>        position_momentum &lt;-<span class="st"> </span>state1<span class="op">$</span>valid_state</span>
<span id="cb14-22"><a href="#cb14-22"></a>      } <span class="cf">else</span> {</span>
<span id="cb14-23"><a href="#cb14-23"></a>        state1 &lt;-<span class="st"> </span><span class="kw">build_efficient_tree</span>(state<span class="op">$</span>rightmost, slice, direction, tree_depth <span class="op">-</span><span class="st"> </span>1L,</span>
<span id="cb14-24"><a href="#cb14-24"></a>                                       <span class="dt">stepsize =</span> stepsize, <span class="dt">deltamax =</span> deltamax, <span class="dt">design =</span> design,</span>
<span id="cb14-25"><a href="#cb14-25"></a>                                       <span class="dt">target =</span> target, <span class="dt">is_log =</span> is_log, <span class="dt">iter =</span> iter,</span>
<span id="cb14-26"><a href="#cb14-26"></a>                                       <span class="dt">run =</span> run, <span class="dt">count =</span> count,</span>
<span id="cb14-27"><a href="#cb14-27"></a>                                       <span class="dt">acceptance =</span> acceptance, <span class="dt">nacceptance =</span> nacceptance)</span>
<span id="cb14-28"><a href="#cb14-28"></a>        state<span class="op">$</span>rightmost &lt;-<span class="st"> </span>state1<span class="op">$</span>rightmost</span>
<span id="cb14-29"><a href="#cb14-29"></a>        position_momentum &lt;-<span class="st"> </span>state1<span class="op">$</span>valid_state</span>
<span id="cb14-30"><a href="#cb14-30"></a>      }</span>
<span id="cb14-31"><a href="#cb14-31"></a>      rate &lt;-<span class="st"> </span>state1<span class="op">$</span>count <span class="op">/</span><span class="st"> </span>(state1<span class="op">$</span>count <span class="op">+</span><span class="st"> </span>state<span class="op">$</span>count)</span>
<span id="cb14-32"><a href="#cb14-32"></a>      <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rate) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">&lt;=</span><span class="st"> </span>rate) state<span class="op">$</span>valid_state &lt;-<span class="st"> </span>position_momentum</span>
<span id="cb14-33"><a href="#cb14-33"></a>      <span class="co"># if any state is 0 Stopping criteria is triggered for trajectory iterations</span></span>
<span id="cb14-34"><a href="#cb14-34"></a>      run &lt;-<span class="st"> </span>run <span class="op">*</span><span class="st"> </span>state1<span class="op">$</span>run <span class="op">*</span><span class="st"> </span><span class="kw">is_U_turn</span>(state)</span>
<span id="cb14-35"><a href="#cb14-35"></a>      count &lt;-<span class="st"> </span>count <span class="op">+</span><span class="st"> </span>state<span class="op">$</span>count <span class="op">+</span><span class="st"> </span>state1<span class="op">$</span>count</span>
<span id="cb14-36"><a href="#cb14-36"></a>      acceptance &lt;-<span class="st"> </span>acceptance <span class="op">+</span><span class="st"> </span>state<span class="op">$</span>acceptance<span class="op">$</span>acceptance <span class="op">+</span><span class="st"> </span>state1<span class="op">$</span>acceptance<span class="op">$</span>acceptance</span>
<span id="cb14-37"><a href="#cb14-37"></a>      nacceptance &lt;-<span class="st"> </span>nacceptance <span class="op">+</span><span class="st"> </span>state<span class="op">$</span>acceptance<span class="op">$</span>nacceptance <span class="op">+</span><span class="st"> </span>state1<span class="op">$</span>acceptance<span class="op">$</span>nacceptance</span>
<span id="cb14-38"><a href="#cb14-38"></a>      state<span class="op">$</span>run &lt;-<span class="st"> </span>run</span>
<span id="cb14-39"><a href="#cb14-39"></a>      state<span class="op">$</span>count &lt;-<span class="st"> </span>count</span>
<span id="cb14-40"><a href="#cb14-40"></a>      state<span class="op">$</span>acceptance<span class="op">$</span>acceptance &lt;-<span class="st"> </span>acceptance</span>
<span id="cb14-41"><a href="#cb14-41"></a>      state<span class="op">$</span>acceptance<span class="op">$</span>nacceptance &lt;-<span class="st"> </span>nacceptance</span>
<span id="cb14-42"><a href="#cb14-42"></a>    }</span>
<span id="cb14-43"><a href="#cb14-43"></a></span>
<span id="cb14-44"><a href="#cb14-44"></a>    <span class="kw">return</span>(state)</span>
<span id="cb14-45"><a href="#cb14-45"></a>  }</span>
<span id="cb14-46"><a href="#cb14-46"></a>}</span>
<span id="cb14-47"><a href="#cb14-47"></a><span class="co"># ______________________________________________________________________________</span></span>
<span id="cb14-48"><a href="#cb14-48"></a><span class="co">#&#39; Build One Tree</span></span>
<span id="cb14-49"><a href="#cb14-49"></a><span class="co">#&#39;</span></span>
<span id="cb14-50"><a href="#cb14-50"></a><span class="co">#&#39; Builds one tree doing a leapfrogstep in one direction</span></span>
<span id="cb14-51"><a href="#cb14-51"></a><span class="co">#&#39;</span></span>
<span id="cb14-52"><a href="#cb14-52"></a><span class="co">#&#39; @inheritParams build_tree</span></span>
<span id="cb14-53"><a href="#cb14-53"></a>build_leaf_simply &lt;-<span class="st"> </span><span class="cf">function</span>(position_momentum, slice, direction, tree_depth, stepsize, deltamax,</span>
<span id="cb14-54"><a href="#cb14-54"></a>                       <span class="dt">design =</span> <span class="ot">NULL</span>, <span class="dt">target =</span> <span class="ot">NULL</span>, <span class="dt">iter =</span> <span class="ot">NULL</span>, is_log) {</span>
<span id="cb14-55"><a href="#cb14-55"></a>  args &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw">is.null</span>(design) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">is.null</span>(target)) {</span>
<span id="cb14-56"><a href="#cb14-56"></a>    <span class="kw">list</span>(position_momentum<span class="op">$</span>position)</span>
<span id="cb14-57"><a href="#cb14-57"></a>  } <span class="cf">else</span> <span class="kw">list</span>(position_momentum<span class="op">$</span>position, design, target)</span>
<span id="cb14-58"><a href="#cb14-58"></a>  gradient_step &lt;-<span class="st"> </span><span class="kw">do.call</span>(gradient, args)</span>
<span id="cb14-59"><a href="#cb14-59"></a>  step &lt;-<span class="st"> </span><span class="kw">leapfrog</span>(position_momentum<span class="op">$</span>position, position_momentum<span class="op">$</span>momentum,</span>
<span id="cb14-60"><a href="#cb14-60"></a>                   <span class="dt">stepsize =</span> (direction <span class="op">*</span><span class="st"> </span>stepsize), <span class="dt">gradient =</span> gradient_step)</span>
<span id="cb14-61"><a href="#cb14-61"></a>  proposal_state &lt;-<span class="st"> </span><span class="kw">do.call</span>(initialize_state, <span class="kw">c</span>(step, <span class="st">&quot;efficient&quot;</span> =<span class="st"> </span><span class="op">!</span><span class="kw">is.null</span>(iter)))</span>
<span id="cb14-62"><a href="#cb14-62"></a>  proposal_density &lt;-<span class="st"> </span><span class="kw">do.call</span>(joint_probability, <span class="kw">c</span>(step, <span class="kw">list</span>(design), <span class="kw">list</span>(target), <span class="st">&quot;is_log&quot;</span> =<span class="st"> </span>is_log))</span>
<span id="cb14-63"><a href="#cb14-63"></a>  valid &lt;-<span class="st"> </span>slice <span class="op">&lt;=</span><span class="st"> </span><span class="kw">exp</span>(proposal_density)</span>
<span id="cb14-64"><a href="#cb14-64"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(iter)) {</span>
<span id="cb14-65"><a href="#cb14-65"></a>    proposal_state<span class="op">$</span>count &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(valid)</span>
<span id="cb14-66"><a href="#cb14-66"></a>    quotient_lik &lt;-<span class="st"> </span><span class="kw">exp</span>(proposal_density <span class="op">-</span><span class="st"> </span><span class="kw">do.call</span>(joint_probability, <span class="kw">c</span>(iter, <span class="kw">list</span>(design), <span class="kw">list</span>(target), <span class="st">&quot;is_log&quot;</span> =<span class="st"> </span>is_log)))</span>
<span id="cb14-67"><a href="#cb14-67"></a>    proposal_state<span class="op">$</span>acceptance<span class="op">$</span>acceptance &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="dv">1</span>, quotient_lik)</span>
<span id="cb14-68"><a href="#cb14-68"></a>    proposal_state<span class="op">$</span>valid_state &lt;-<span class="st"> </span>step</span>
<span id="cb14-69"><a href="#cb14-69"></a>  }</span>
<span id="cb14-70"><a href="#cb14-70"></a>  proposal_state<span class="op">$</span>run &lt;-<span class="st"> </span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>(<span class="kw">exp</span>(proposal_density <span class="op">+</span><span class="st"> </span>deltamax) <span class="op">&gt;</span><span class="st"> </span>slice)</span>
<span id="cb14-71"><a href="#cb14-71"></a>  proposal_state</span>
<span id="cb14-72"><a href="#cb14-72"></a>}</span></code></pre></div>
</section><section id="summarize-nuts" class="slide level2">
<h2>Summarize NUTS</h2>
The sampling procedure is summarized as follows: <br><br>
<div class="fragment">
<ol type="1">
<li>Set the initial value of <span class="math inline">\(theta\)</span>, <span class="math inline">\(\epsilon\)</span> and values of <span class="math inline">\(\delta\)</span> <span class="math inline">\(t_0\)</span>, <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\gamma\)</span> <span class="math inline">\(-\kappa\)</span></li>
</ol>
</div>
<br>
<div class="fragment">
<ol start="2" type="1">
<li>Generate momentum <span class="math inline">\(r_0\)</span> from the standard normal distribution rN(0,I).</li>
</ol>
</div>
<br>
<div class="fragment">
<ol start="3" type="1">
<li>Generate slice variable u from the uniform distribution <span class="math inline">\(sUniform(0,exp(logf(\theta)\frac{1}{2}r^Tr))\)</span>.</li>
</ol>
</div>
<br>
<div class="fragment">
<ol start="4" type="1">
<li>Generate valid states <span class="math inline">\(\mathcal{C}\)</span> by using the doubling method and sample a proposal <span class="math inline">\((\hat{\theta},\hat{r})\)</span> iteratively</li>
</ol>
</div>
<br>
<div class="fragment">
<ol start="5" type="1">
<li>Accept the proposal <span class="math inline">\((\hat{\theta},\hat{r})\)</span> with probability proportional to the valid_set size.</li>
</ol>
</div>
<br>
<div class="fragment">
<ol start="6" type="1">
<li>Update <span class="math inline">\(\epsilon^t\)</span> by dual averaging.</li>
</ol>
</div>
<br>
<div class="fragment">
<ol start="7" type="1">
<li>Repeat steps 2 to 6, step 6 is repeated only during the warm-up phase. <br> see <span class="citation" data-cites="nishio">Nishio and Arakawa (2019)</span></li>
</ol>
</div>
</section></section>
<section><section id="examples" class="title-slide slide level1"><h1>Examples</h1><center>
<img data-src="files/DancingPeaks.gif" /><!-- -->
</center></section><section id="regression---an-artificial-data-set" class="slide level2">
<h2>Regression - an artificial data set</h2>
<p>Generate data:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>design &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dv">1</span>, <span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">runif</span>(<span class="dv">400</span>)))</span>
<span id="cb15-2"><a href="#cb15-2"></a>perfect_position &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb15-3"><a href="#cb15-3"></a>target &lt;-<span class="st"> </span>design <span class="op">%*%</span><span class="st"> </span>perfect_position <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">400</span>)</span></code></pre></div>
<div class="fragment">
<p>Take a look at the data:</p>
<p><img src="Presentation_files/figure-revealjs/unnamed-chunk-36-1.png" width="50%" /></p>
</div>
</section><section id="regression---set-up-nuts" class="slide level2">
<h2>Regression - Set Up NUTS</h2>
<div class="fragment">
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>posterior_density =<span class="st"> </span>log_linear</span>
<span id="cb16-2"><a href="#cb16-2"></a>gradient =<span class="st"> </span>partial_deriv_lin</span></code></pre></div>
</div>
<div class="fragment">
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>linear39 &lt;-<span class="st"> </span><span class="kw">sample_noUturn</span>(<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>), <span class="dt">iteration =</span> <span class="fl">2e3</span>, <span class="dt">design =</span> design, <span class="dt">target =</span> target,</span>
<span id="cb17-2"><a href="#cb17-2"></a>                         <span class="dt">is_log =</span> <span class="ot">TRUE</span>, <span class="dt">seed =</span> 123L, <span class="dt">target_accpentance =</span> <span class="fl">.39</span>, <span class="dt">max_tree_depth =</span> 12L)</span></code></pre></div>
</div>
<div class="fragment">

</div>
<div class="fragment">
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">lm</span>(target<span class="op">~</span>., <span class="dt">data =</span> <span class="kw">as.data.frame</span>(design[,<span class="op">-</span><span class="dv">1</span>]))</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = target ~ ., data = as.data.frame(design[, -1]))
## 
## Coefficients:
## (Intercept)           V1           V2  
##      0.8961       2.3980       2.8388</code></pre>
</div>
</section><section id="regression---trace-plot-for-parameters" class="slide level2">
<h2>Regression - Trace Plot for parameters</h2>
<p><img data-src="Presentation_files/figure-revealjs/unnamed-chunk-42-1.png" /><!-- --></p>
</section><section id="regression---autocorrelation" class="slide level2">
<h2>Regression - Autocorrelation</h2>
<p><img data-src="Presentation_files/figure-revealjs/unnamed-chunk-43-1.png" /><!-- --></p>
</section><section id="classification---endometrial-data-set" class="slide level2">
<h2>Classification - Endometrial data Set</h2>
<p><br> <br> <br> <br></p>
<ul>
<li><strong>Goal:</strong> Predict whether a person has endometrial cancer or not.</li>
</ul>
<br>
<div class="fragment">
<p><strong>Dataset:</strong> A data frame with 79 rows and 4 variables: <br> NV Neovasculation risk factor indicator (0=Absent, 1=Present) <br> PI Pulsatility index of arteria uterina <br> EH Endometrium height <br></p>
</div>
<div class="fragment">
<ul>
<li>We standardize the data to get an estimates independent from their scale.</li>
</ul>
</div>
</section><section id="classification---define-posterior-and-gradient-function" class="slide level2">
<h2>Classification - Define posterior and gradient function</h2>
<small>
<div class="fragment">
<p><span class="math display">\[ \begin{aligned}
f(\mathbf{y} | \mathbf{X},\boldsymbol\beta) &amp;= \prod_{i=1}^n p^{y_i} (1-p)^{1-y_i}, \\
&amp;= \prod_{i=1}^{n} \left(\frac{1}{1+e^{-\mathbf{x}i^T\boldsymbol\beta}}\right)^{y_i} \left(\frac{e^{-\mathbf{x}_i^T\boldsymbol\beta}}{1+e^{-\mathbf{x}_i^T\boldsymbol\beta}}\right)^{1-y_i}, \\
\log f(\mathbf{y} | \mathbf{X}, \boldsymbol\beta) &amp;= \sum{i=1}^n -y_i\log(1+e^{-\mathbf{x}i^T\boldsymbol\beta}) + (1-y_i)(-\mathbf{x}_i\boldsymbol\beta - \log(1+e^{-\mathbf{x}_i^T\boldsymbol\beta})), \\
&amp;= \sum{i=1}^n -\log(1+e^{-\mathbf{x}i\boldsymbol\beta}) - \mathbf{x}_i^T\boldsymbol\beta(1 - y_i), \\
&amp;= \sum{i=1}^n \mathbf{x}_i^T\boldsymbol\beta(y_i - 1) - \log(1 + e^{-\mathbf{x}_i^T\boldsymbol\beta}), \\
&amp;= \boldsymbol\beta^T\mathbf{X}^T(\mathbf{y} - \mathbf{1}_n) - \mathbf{1}_n^T [ \log( 1 + e^{-\mathbf{X}\boldsymbol\beta})].
\end{aligned} \]</span></p>
</div>
<div class="fragment">
<p>We set a multivariate normal prior for <span class="math inline">\(\boldsymbol\beta\)</span></p>
<p><span class="math display">\[
\begin{aligned} \boldsymbol\beta &amp;\sim N(0, \sigma^2 \mathbf{I}), \end{aligned}
\]</span></p>
</div>
<div class="fragment">
<p>with pdf, omitting constants</p>
<p><span class="math display">\[
\begin{aligned}
\pi(\boldsymbol\beta | \sigma^2) &amp;= \frac{1}{\sqrt{\lvert 2\pi \sigma^2 \rvert }}e^{-\frac{1}{2}\boldsymbol\beta^T \boldsymbol\beta / \sigma^2}, \\
\log \pi(\boldsymbol\beta | \sigma^2) &amp;= -\frac{1}{2}\log(2\pi \sigma^2) - \frac{1}{2}\boldsymbol\beta^T \boldsymbol\beta / \sigma^2, \\
&amp;\propto -\frac{1}{2}\log \sigma^2 - \frac{\boldsymbol\beta^T\boldsymbol\beta}{2\sigma^2}. 
\end{aligned}
\]</span></p>
</div>
<p></small></p>
</section><section id="classification---define-posterior-and-gradient-function-ii" class="slide level2">
<h2>Classification - Define posterior and gradient function II</h2>
<small>
<div class="fragment">
<p>Next, we derive the log posterior, omitting constants,</p>
<p><span class="math display">\[
\begin{aligned}
f(\boldsymbol\beta | \mathbf{X}, \mathbf{y}, \sigma^2) &amp;\propto f(\mathbf{y} | \mathbf{X}, \boldsymbol\beta) \pi(\boldsymbol\beta | \sigma^2), \\
\log f(\boldsymbol\beta | \mathbf{X}, \mathbf{y}, \sigma^2) &amp;  \propto \log f(\mathbf{y} | \mathbf{X}, \boldsymbol\beta) + \log \pi(\boldsymbol\beta|\sigma^2), \\
&amp;\propto \sum_{i=1}^n \mathbf{x}i^T\boldsymbol\beta(y_i - 1) - \log(1 + e^{-\mathbf{x}_i^T\boldsymbol\beta}) - \frac{1}{2}\boldsymbol\beta^T\boldsymbol\beta / \sigma^2, \\
&amp;\propto \boldsymbol\beta^T\mathbf{X}^T(\mathbf{y} - \mathbf{1}n) - \mathbf{1}_n^T[\log( 1 + e^{-\mathbf{X}\boldsymbol\beta})] - \frac{\boldsymbol\beta^T\boldsymbol\beta}{2\sigma^2}. 
\end{aligned} 
\]</span></p>
</div>
<div class="fragment">
<p>Next, we need to derive the gradient of the log posterior for the leapfrog function</p>
<p><span class="math display">\[ 
\begin{aligned}
\nabla_{\boldsymbol\beta} \log f(\boldsymbol\beta, \mathbf{X}, \mathbf{y}, \sigma^2) &amp;\propto \mathbf{X}^T \left ( \mathbf{y} - \mathbf{1}n+ \frac{e^{-\mathbf{X}\boldsymbol\beta}}{1 + e^{-\mathbf{X}\boldsymbol\beta}}\right) - \boldsymbol\beta / \sigma^2 
\end{aligned}
\]</span> <span class="citation" data-cites="thomas">Thomas and Tu (2020)</span></p>
</div>
</small>
<div class="fragment">
<p>Finally simply initialize the functions:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>posterior_density =<span class="st"> </span>bernoulli_pen</span>
<span id="cb20-2"><a href="#cb20-2"></a>gradient =<span class="st"> </span>partial_deriv_benoulli</span></code></pre></div>
</div>
</section><section id="classification---run-hmc" class="slide level2">
<h2>Classification - Run HMC</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>hmc &lt;-<span class="st"> </span><span class="kw">hamiltonianMC</span>(<span class="kw">runif</span>(<span class="dv">4</span>, <span class="dv">-5</span>, <span class="dv">5</span>), <span class="dt">iterations =</span> <span class="fl">5e3</span>,<span class="dt">stepsize =</span> <span class="fl">0.1</span>, <span class="dt">leapfrogsteps =</span> <span class="dv">10</span>, <span class="dt">design =</span>  X, <span class="dt">target =</span> y)</span></code></pre></div>
<p><img data-src="Presentation_files/figure-revealjs/unnamed-chunk-49-1.png" /><!-- --></p>
</section><section id="classification---run-nuts" class="slide level2">
<h2>Classification - Run NUTS</h2>
<p><br><br><br></p>
<p>Run <code>sample_noUturn</code> for 5000 iterations with a small target acceptance of <code>0.39</code> As our posterior is already logged we ca specify the <code>is_logged</code> argument as <code>TRUE</code></p>
<p>We use a weak prior where <span class="math inline">\(\sigma^2I = 200I\)</span>, this is analog t a very week penalty.</p>
<div class="fragment">
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>initial_pos &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="cf">function</span>(x) <span class="kw">runif</span>(<span class="dv">4</span>, <span class="dv">-5</span>, <span class="dv">5</span>))</span>
<span id="cb22-2"><a href="#cb22-2"></a>param_sample_binary &lt;-<span class="st"> </span><span class="kw">lapply</span>(initial_pos, sample_noUturn, <span class="dt">iteration =</span> <span class="fl">5e3</span>,</span>
<span id="cb22-3"><a href="#cb22-3"></a>                              <span class="dt">design =</span> X, <span class="dt">target =</span> y,</span>
<span id="cb22-4"><a href="#cb22-4"></a>                              <span class="dt">is_log =</span> <span class="ot">TRUE</span>, <span class="dt">target_accpentance =</span> <span class="fl">.39</span>,</span>
<span id="cb22-5"><a href="#cb22-5"></a>                              <span class="dt">max_tree_depth =</span> 12L)</span></code></pre></div>
</div>
<ul>
<li class="fragment">This took 24 hours of calculation, plus preparation.</li>
</ul>
</section><section id="trace-the-run" class="slide level2">
<h2>Trace the run</h2>
<p><img src="Presentation_files/figure-revealjs/unnamed-chunk-53-1.png" width="50%" /></p>
<p>Sationary log-epsilon after adaptive Warm Up:</p>
<pre><code>## [1] -11.32922 -11.64710</code></pre>
</section><section id="classification---check-convergence-by-traceplots" class="slide level2">
<h2>Classification - Check Convergence by Traceplots</h2>
<p><img data-src="Presentation_files/figure-revealjs/unnamed-chunk-55-1.png" /><!-- --></p>
</section><section id="classification---check-convergence-by-density-plots" class="slide level2">
<h2>Classification - Check Convergence by Density Plots</h2>
<p><img data-src="Presentation_files/figure-revealjs/unnamed-chunk-56-1.png" /><!-- --></p>
</section><section id="classification---prediction-and-comparison" class="slide level2">
<h2>Classification - Prediction and Comparison</h2>
<br> <br>
<div class="fragment">
<p>Lets compare our models mean parameter Estimators to those of a GLM</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>f &lt;-<span class="st"> </span>glmnet<span class="op">::</span><span class="kw">glmnet</span>(X, y, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="dt">lambda =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">200</span>)</span></code></pre></div>
</div>
<br> <br>
<div class="fragment">

<table>
<caption>
parameter Estimates mode for last 1000 iterations vs penalized GLM
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
intercept
</th>
<th style="text-align:right;">
slope1
</th>
<th style="text-align:right;">
slope2
</th>
<th style="text-align:right;">
slope3
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Sample1
</td>
<td style="text-align:right;">
2.18
</td>
<td style="text-align:right;">
-0.32
</td>
<td style="text-align:right;">
-1.93
</td>
<td style="text-align:right;">
6.74
</td>
</tr>
<tr>
<td style="text-align:left;">
Sample2
</td>
<td style="text-align:right;">
0.73
</td>
<td style="text-align:right;">
-0.23
</td>
<td style="text-align:right;">
-2.02
</td>
<td style="text-align:right;">
4.22
</td>
</tr>
<tr>
<td style="text-align:left;">
Sample3
</td>
<td style="text-align:right;">
1.06
</td>
<td style="text-align:right;">
-0.41
</td>
<td style="text-align:right;">
-2.05
</td>
<td style="text-align:right;">
4.47
</td>
</tr>
<tr>
<td style="text-align:left;">
Sample4
</td>
<td style="text-align:right;">
0.96
</td>
<td style="text-align:right;">
-0.37
</td>
<td style="text-align:right;">
-2.30
</td>
<td style="text-align:right;">
4.69
</td>
</tr>
<tr>
<td style="text-align:left;">
regularized GLM
</td>
<td style="text-align:right;">
0.87
</td>
<td style="text-align:right;">
-0.31
</td>
<td style="text-align:right;">
-1.80
</td>
<td style="text-align:right;">
4.14
</td>
</tr>
</tbody>
</table>
</div>
<!---
<div class="fragment">


In the following we can see the average deviation of one prediction from the true value is about 20% uncertainty:


```
## [1] 0.2214431 0.2153835 0.2195734 0.2079853
```
</div>

## Regression - Data Set

**Data Set Information:**

The data was retrieved from a set of 53500 CT images from 74 different
patients (43 male, 31 female).

<div class="fragment">

Each CT slice is described by two histograms in polar space.
The first histogram describes the location of bone structures in the image,
the second the location of air inclusions inside of the body.
Both histograms are concatenated to form the final feature vector.
Bins that are outside of the image are marked with the value -0.25.

</div>
<div class="fragment">

The class variable (relative location of an image on the axial axis) was
constructed by manually annotating up to 10 different distinct landmarks in
each CT Volume with known location. The location of slices in between
landmarks was interpolated.

</div>
<div class="fragment">

**Attribute Information:**

1. patientId: Each ID identifies a different patient
2. - 241.: Histogram describing bone structures
242. - 385.: Histogram describing air inclusions

*target:* 

reference: Relative location of the image on the axial axis (class
value). Values are in the range [0; 180] where 0 denotes
the top of the head and 180 the soles of the feet.


</div>


## Regression - Define posterior and gradient function

<div class="fragment">
$$ \begin{aligned}
f(\mathbf{y} | \mathbf{X},\boldsymbol\beta, v) &= \prod_{i=1}^n \frac{1}{\Gamma(v)}(\frac{vy_i}{\mu_i})^ve^{\frac{v}{\mu_i}y_i}\frac{1}{y_i}, \\
\log f(\mathbf{y} | \mathbf{X}, \boldsymbol\beta, v) &= \sum_{i=1}^n (v-1) log(y_i) - \frac{v}{\mu_i}y_i+vlog(v)-vlog(\mu_i)-log(\Gamma(v)), \\
&= \sum_{i=1}^n (v-1) log(y_i) - \frac{v}{exp(x_i^T\beta)}y_i+vlog(v)-vx_i^t\beta-log(\Gamma(v)),\\
\Delta_{\beta}\log f(\mathbf{y} | \mathbf{X}, \boldsymbol\beta, v)&\propto vX^T((\frac{1}{exp(X\beta)}\otimes y) - 1), \\
\Delta_{v}\log f(\mathbf{y} | \mathbf{X}, \boldsymbol\beta, v)&\propto \sum_{i=1}^n log(y_i) -  \frac{1}{exp(x_i^T\beta)}y_i - log(v) -1 - x_i^t\beta- \frac{1}{\Gamma(v)} \Gamma^{\prime}(v)
\end{aligned} $$

<div class="fragment">
Finally simply initialize the functions:




```r
posterior_density = gamma_distr
gradient = partial_deriv_gamma
```
</div>

## Regression - Run NUTS


```r
start <- Sys.time()
initial_pos <- lapply(1:3, function(x) c(runif(1), runif(386, 16, 18)))
sigmoid_parameter_distrib <- lapply(initial_pos, sample_noUturn, iteration = 10, design = design, target = target, is_log = TRUE, seed = 123L, target_accpentance = .65, max_tree_depth = 11L)
dif2000iter <- Sys.time() - start
dif2000iter
```

--->
</section></section>
<section><section id="section-5" class="title-slide slide level1" data-background="files/stan.png" data-background-size="800px 600px"><h1></h1></section><section id="presettings" class="slide level2">
<h2>Presettings</h2>
<p><strong>Loading the package</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw">library</span>(<span class="st">&quot;rstan&quot;</span>)</span></code></pre></div>
<p><strong>To estimate your model in parallel</strong></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">options</span>(<span class="dt">mc.cores =</span> parallel<span class="op">::</span><span class="kw">detectCores</span>())</span></code></pre></div>
<p>Automatically save a bare version of a compiled Stan program to the hard disk so that it does not need to be recompiled</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">rstan_options</span>(<span class="dt">auto_write =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>You will need to run these commands each time you load the rstan library.</p>
</section><section id="example-eight-schools---setup" class="slide level2">
<h2>Example Eight Schools - SetUp</h2>
<p>This is an example in Section 5.5 of <span class="citation" data-cites="gelman13">Gelman et al. (2013)</span>, which studied coaching effects from eight schools.</p>
<p>We start by writing a Stan program for the model in a text file. If you are using RStudio click on <code>File -&gt; New File -&gt; Stan File</code> . Either way, paste in the following and save your work to a file called <code>schools.stan</code> in Rs working directory.</p>
<pre class="stan"><code>// saved as schools.stan
data {
  int&lt;lower=0&gt; J;         // number of schools 
  real y[J];              // estimated treatment effects
  real&lt;lower=0&gt; sigma[J]; // standard error of effect estimates 
}
parameters {
  real mu;                // population treatment effect
  real&lt;lower=0&gt; tau;      // standard deviation in treatment effects
  vector[J] eta;          // unscaled deviation from mu by school
}
transformed parameters {
  vector[J] theta = mu + tau * eta;        // school treatment effects
}
model {
  target += normal_lpdf(eta | 0, 1);       // prior log-density
  target += normal_lpdf(y | theta, sigma); // log-likelihood
}
</code></pre>
<p>In this Stan program, we let <code>theta</code> be a transformation of <code>mu</code>, <code>eta</code>, and <code>tau</code> instead of declaring <code>theta</code> in the <code>parameters</code> block, which allows the sampler will run more efficiently (<a href="http://mc-stan.org/documentation/case-studies/divergences_and_bias.html">see detailed explanation</a>). We can prepare the data (which typically is a named list) in R with:</p>
</section><section id="example-eight-schools---run" class="slide level2">
<h2>Example Eight Schools - Run</h2>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>schools_dat &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">J =</span> <span class="dv">8</span>, </span>
<span id="cb29-2"><a href="#cb29-2"></a>                    <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">28</span>,  <span class="dv">8</span>, <span class="dv">-3</span>,  <span class="dv">7</span>, <span class="dv">-1</span>,  <span class="dv">1</span>, <span class="dv">18</span>, <span class="dv">12</span>),</span>
<span id="cb29-3"><a href="#cb29-3"></a>                    <span class="dt">sigma =</span> <span class="kw">c</span>(<span class="dv">15</span>, <span class="dv">10</span>, <span class="dv">16</span>, <span class="dv">11</span>,  <span class="dv">9</span>, <span class="dv">11</span>, <span class="dv">10</span>, <span class="dv">18</span>))</span></code></pre></div>
<p>And we can get a fit with the following R command. Note that the argument to <code>file =</code> should point to where the file is on your file system unless you have put it in the working directory of R in which case the below will work.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>fit &lt;-<span class="st"> </span><span class="kw">stan</span>(<span class="dt">file =</span> <span class="st">&#39;schools.stan&#39;</span>, <span class="dt">data =</span> schools_dat)</span></code></pre></div>
<p>The object <code>fit</code>, returned from function <code>stan</code> is an <a href="https://cran.r-project.org/package=rstan/vignettes/stanfit-objects.html">S4 object</a> of class <code>stanfit</code>.</p>
</section><section id="example-eight-schools---evaluate" class="slide level2">
<h2>Example Eight Schools - Evaluate</h2>
<p>Methods such as <code>print</code>, <code>plot</code>, and <code>pairs</code> are associated with the fitted result so we can use the following code to check out the results in <code>fit</code>. <code>print</code> provides a summary for the parameter of the model as well as the log-posterior with name <code>lp__</code> (see the following example output). For more methods and details of class <code>stanfit</code>, see the help of class <code>stanfit</code>. We can use the <code>extract</code> function on <code>stanfit</code> objects to obtain the samples.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">print</span>(fit)</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="kw">plot</span>(fit)</span>
<span id="cb31-3"><a href="#cb31-3"></a></span>
<span id="cb31-4"><a href="#cb31-4"></a>la &lt;-<span class="st"> </span><span class="kw">extract</span>(fit, <span class="dt">permuted =</span> <span class="ot">TRUE</span>) <span class="co"># return a list of arrays </span></span>
<span id="cb31-5"><a href="#cb31-5"></a>mu &lt;-<span class="st"> </span>la<span class="op">$</span>mu </span>
<span id="cb31-6"><a href="#cb31-6"></a></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="co">### return an array of three dimensions: iterations, chains, parameters </span></span>
<span id="cb31-8"><a href="#cb31-8"></a>a &lt;-<span class="st"> </span><span class="kw">extract</span>(fit, <span class="dt">permuted =</span> <span class="ot">FALSE</span>) </span>
<span id="cb31-9"><a href="#cb31-9"></a></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="co">### use S3 functions on stanfit objects</span></span>
<span id="cb31-11"><a href="#cb31-11"></a>a2 &lt;-<span class="st"> </span><span class="kw">as.array</span>(fit)</span>
<span id="cb31-12"><a href="#cb31-12"></a>m &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(fit)</span>
<span id="cb31-13"><a href="#cb31-13"></a>d &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(fit)</span></code></pre></div>
</section><section id="example-eight-schools---plot-distributions" class="slide level2">
<h2>Example Eight Schools - Plot Distributions</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">pairs</span>(fit, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">&quot;mu&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;lp__&quot;</span>))</span></code></pre></div>
<p><img data-src="Presentation_files/figure-revealjs/unnamed-chunk-73-1.png" /><!-- --></p>
</section></section>
<section id="references" class="title-slide slide level1 unnumbered"><h1>References</h1><div id="refs" class="references" role="doc-bibliography">
<div id="ref-feng20">
<p>Feng, Chi. 2016. MCMC Demo. <em>GitHub Repository</em>. <a href="https://github.com/chi-feng/mcmc-demo">https://github.com/chi-feng/mcmc-demo</a>; GitHub.</p>
</div>
<div id="ref-gelman13">
<p>Gelman, Andrew, John B Carlin, Hal S Stern, David B Dunson, Aki Vehtari, and Donald B Rubin. 2013. <em>Bayesian Data Analysis</em>. CRC press.</p>
</div>
<div id="ref-hoffman2014">
<p>Hoffman, Matthew D, and Andrew Gelman. 2014. The No-U-Turn Sampler: Adaptively Setting Path Lengths in Hamiltonian Monte Carlo. <em>J. Mach. Learn. Res.</em> 15 (1): 15931623.</p>
</div>
<div id="ref-nishio">
<p>Nishio, Motohide, and Aisaku Arakawa. 2019. Performance of Hamiltonian Monte Carlo and No-U-Turn Sampler for Estimating Genetic Parameters and Breeding Values. <em>Genetics Selection Evolution</em> 51 (1): 73.</p>
</div>
<div id="ref-thomas">
<p>Thomas, Samuel, and Wanzhu Tu. 2020. Learning Hamiltonian Monte Carlo in R. <em>arXiv Preprint arXiv:2006.16194</em>.</p>
</div>
</div></section>
    </div>
  </div>

  <script src="Presentation_files/reveal.js-3.3.0.1/lib/js/head.min.js"></script>
  <script src="Presentation_files/reveal.js-3.3.0.1/js/reveal.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Display the page number of the current slide
        slideNumber: true,
        // Push each slide change to the browser history
        history: true,
        // Vertical centering of slides
        center: false,
        // Transition style
        transition: 'none', // none/fade/slide/convex/concave/zoom
        // Transition style for full page slide backgrounds
        backgroundTransition: 'default', // none/fade/slide/convex/concave/zoom

        menu: {
          custom: false,
          themes: false,
          transitions: false
        },



        // Optional reveal.js plugins
        dependencies: [
          { src: 'Presentation_files/reveal.js-3.3.0.1/plugin/notes/notes.js', async: true },
          { src: 'Presentation_files/reveal.js-3.3.0.1/plugin/zoom-js/zoom.js', async: true },
          { src: 'Presentation_files/reveal.js-3.3.0.1/plugin/menu/menu.js', async: true },
        ]
      });
    </script>
  <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>

<script>
  (function() {
    if (window.jQuery) {
      Reveal.addEventListener( 'slidechanged', function(event) {  
        window.jQuery(event.previousSlide).trigger('hidden');
        window.jQuery(event.currentSlide).trigger('shown');
      });
    }
  })();
</script>


  </body>
</html>
